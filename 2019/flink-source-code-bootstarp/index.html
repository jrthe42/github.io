<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Flink 源码阅读笔记（5）- 集群启动流程 - JR&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="jrthe42" /><meta name="description" content="在 Flink 1.5.0 版本发布的时候，Flink 迎来了一个重要的改进：根据 FLIP-6 重构了 Flink 集群部署和任务处理模型，以便更好地和管理资源和调度任务，更优雅地和 Yar" /><meta name="keywords" content="jrthe42, Blog, Programming" />






<meta name="generator" content="Hugo 0.58.0 with theme even" />


<link rel="canonical" href="https://blog.jrwang.me/2019/flink-source-code-bootstarp/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.7d171193.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Flink 源码阅读笔记（5）- 集群启动流程" />
<meta property="og:description" content="在 Flink 1.5.0 版本发布的时候，Flink 迎来了一个重要的改进：根据 FLIP-6 重构了 Flink 集群部署和任务处理模型，以便更好地和管理资源和调度任务，更优雅地和 Yar" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.jrwang.me/2019/flink-source-code-bootstarp/" />
<meta property="article:published_time" content="2019-05-05T21:42:38+00:00" />
<meta property="article:modified_time" content="2019-05-05T21:42:38+00:00" />
<meta itemprop="name" content="Flink 源码阅读笔记（5）- 集群启动流程">
<meta itemprop="description" content="在 Flink 1.5.0 版本发布的时候，Flink 迎来了一个重要的改进：根据 FLIP-6 重构了 Flink 集群部署和任务处理模型，以便更好地和管理资源和调度任务，更优雅地和 Yar">


<meta itemprop="datePublished" content="2019-05-05T21:42:38&#43;00:00" />
<meta itemprop="dateModified" content="2019-05-05T21:42:38&#43;00:00" />
<meta itemprop="wordCount" content="6108">



<meta itemprop="keywords" content="Flink," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Flink 源码阅读笔记（5）- 集群启动流程"/>
<meta name="twitter:description" content="在 Flink 1.5.0 版本发布的时候，Flink 迎来了一个重要的改进：根据 FLIP-6 重构了 Flink 集群部署和任务处理模型，以便更好地和管理资源和调度任务，更优雅地和 Yar"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">JRTHE42</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">JRTHE42</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Flink 源码阅读笔记（5）- 集群启动流程</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-05-05 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#ha-及-leader-选举">HA 及 Leader 选举</a></li>
<li><a href="#minicluster-的启动流程">MiniCluster 的启动流程</a>
<ul>
<li><a href="#创建-highavailabilityservices">创建 <code>HighAvailabilityServices</code></a></li>
<li><a href="#启动-taskmanager">启动 TaskManager</a></li>
<li><a href="#启动-dispatcherresourcemanagercomponent">启动 <code>DispatcherResourceManagerComponent</code></a></li>
<li><a href="#提交-jobgraph">提交 JobGraph</a></li>
</ul></li>
<li><a href="#standalone-cluster-模式的启动流程">Standalone Cluster 模式的启动流程</a>
<ul>
<li><a href="#jobmanager-的启动">JobManager 的启动</a></li>
<li><a href="#taskmanager-的启动">TaskManager 的启动</a></li>
</ul></li>
<li><a href="#yarn-cluster-的启动流程">Yarn Cluster 的启动流程</a></li>
<li><a href="#小结">小结</a></li>
<li><a href="#参考">参考</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<p>在 Flink 1.5.0 版本发布的时候，Flink 迎来了一个重要的改进：根据 <a href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=65147077">FLIP-6</a> 重构了 Flink 集群部署和任务处理模型，以便更好地和管理资源和调度任务，更优雅地和 Yarn、 Mesos、Kubernetes 等框架进行集成。</p>

<p>在这篇文章中，我们将对 Flink 集群的启动流程加一分析。本文的分析基于 Flink 1.9-SNAPSHOT 版本的代码。</p>

<h2 id="ha-及-leader-选举">HA 及 Leader 选举</h2>

<p>Flink 内部的组件如 ResourceManager， JobManager 等都可以配置 HA 模式，Flink 集群启动的的时候会大量涉及到 Leader 选举，Leader 地址获取等相关的操作，因而先对 HA 相关的概念进行介绍。</p>

<p>Leader 地址的获取通过 <code>LeaderRetrievalLister</code> 和 <code>LeaderRetriverService</code> 这两个接口来完成。 <code>LeaderRetriverService</code> 可以启动一个对 Leader 地址的监听，在 Leader 选举完成后得到通知。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">interface</span> <span class="n">LeaderRetrievalService</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="n">LeaderRetrievalListener</span> <span class="nf">listener</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span><span class="p">;</span>
	<span class="kt">void</span> <span class="nf">stop</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">public</span> <span class="nf">interface</span> <span class="n">LeaderRetrievalListener</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="nf">notifyLeaderAddress</span><span class="p">(</span><span class="nd">@Nullable</span> <span class="n">String</span> <span class="nf">leaderAddress</span><span class="p">,</span> <span class="nd">@Nullable</span> <span class="n">UUID</span> <span class="nf">leaderSessionID</span><span class="p">);</span>
	<span class="kt">void</span> <span class="nf">handleError</span><span class="p">(</span><span class="n">Exception</span> <span class="nf">exception</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><code>GatewayRetriver</code> 接口用于获取 <code>RpcGateway</code>，抽象类 <code>LeaderGatewayRetriver</code> 则同时继承了 <code>LeaderRetriever</code> 和 <code>GatewayRetriver</code>，因而1）可以在Leader选举完成后得到 Leader 地址 2）可以获取到 Leader 的 RpcGateway。</p>

<p><code>RpcGatewayRetriever</code> 是 <code>LeaderGatewayRetriver</code> 的具体实现，根据 Leader 的地址通过 <code>RpcService.connect()</code> 方法获得对应 Leader 的 RpcGateway。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nf">RpcGatewayRetriever</span><span class="o">&lt;</span><span class="n">F</span> <span class="nf">extends</span> <span class="n">Serializable</span><span class="p">,</span> <span class="n">T</span> <span class="nf">extends</span> <span class="n">FencedRpcGateway</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;&gt;</span> <span class="nf">extends</span> <span class="n">LeaderGatewayRetriever</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">createGateway</span><span class="p">(</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">UUID</span><span class="o">&gt;&gt;</span> <span class="nf">leaderFuture</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">FutureUtils</span><span class="p">.</span><span class="na">retryWithDelay</span><span class="p">(</span>
			<span class="p">()</span> <span class="o">-&gt;</span>
				<span class="n">leaderFuture</span><span class="p">.</span><span class="na">thenCompose</span><span class="p">(</span>
					<span class="p">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">UUID</span><span class="o">&gt;</span> <span class="nf">addressLeaderTuple</span><span class="p">)</span> <span class="o">-&gt;</span>
						<span class="n">rpcService</span><span class="p">.</span><span class="na">connect</span><span class="p">(</span>
							<span class="n">addressLeaderTuple</span><span class="p">.</span><span class="na">f0</span><span class="p">,</span>
							<span class="n">fencingTokenMapper</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">addressLeaderTuple</span><span class="p">.</span><span class="na">f1</span><span class="p">),</span>
							<span class="n">gatewayType</span><span class="p">)),</span>
			<span class="n">retries</span><span class="p">,</span>
			<span class="n">retryDelay</span><span class="p">,</span>
			<span class="n">rpcService</span><span class="p">.</span><span class="na">getScheduledExecutor</span><span class="p">());</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Leader 选举是通过 <code>LeaderElectionService</code>（选举服务）和 <code>LeaderContender</code>（参与竞选的对象）共同来完成的，每一次选举成功后都会有唯一的 leaderSessionID，可以用来作为 RpcGateway 通信的 fence token。当一个 <code>LeaderContender</code> 竞选成功了，会通过 <code>LeaderContender#grantLeadership</code> 得到通知。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">interface</span> <span class="n">LeaderElectionService</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="n">LeaderContender</span> <span class="nf">contender</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span><span class="p">;</span>

	<span class="kt">void</span> <span class="nf">stop</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span><span class="p">;</span>

	<span class="kt">void</span> <span class="nf">confirmLeaderSessionID</span><span class="p">(</span><span class="n">UUID</span> <span class="nf">leaderSessionID</span><span class="p">);</span>

	<span class="kt">boolean</span> <span class="nf">hasLeadership</span><span class="p">(</span><span class="nd">@Nonnull</span> <span class="n">UUID</span> <span class="nf">leaderSessionId</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="nf">interface</span> <span class="n">LeaderContender</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="nf">grantLeadership</span><span class="p">(</span><span class="n">UUID</span> <span class="nf">leaderSessionID</span><span class="p">);</span>

	<span class="kt">void</span> <span class="nf">revokeLeadership</span><span class="p">();</span>

	<span class="n">String</span> <span class="nf">getAddress</span><span class="p">();</span>

	<span class="kt">void</span> <span class="nf">handleError</span><span class="p">(</span><span class="n">Exception</span> <span class="nf">exception</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><code>LeaderElectionService</code> 有多种实现，如无需进行选举过程的 <code>StandaloneLeaderElectionService</code>，以及借助 zookeeper 和 curator 框架实现的 <code>ZooKeeperLeaderElectionService</code>，具体的实现细节可参考对应的源码。</p>

<p><code>HighAvailabilityServices</code> 接口则提供了获取 HA 相关所有服务的方法，包括：</p>

<ul>
<li>ResourceManager 选举服务及 Leader 获取</li>
<li>Dispatcher 选举服务及 Leader 获取</li>
<li>任务状态的注册表</li>
<li>checkpoint recovery、blob store 等相关的服务</li>
</ul>

<h2 id="minicluster-的启动流程">MiniCluster 的启动流程</h2>

<p>我们先从最为简单的 MiniCluster 着手，分析一下 Flink 的启动流程以及内部各组件之间的交互。 MiniCluster 看一看做是一个内嵌的 Flink 运行时环境，所有的组件都在独立的本地线程中运行。MiniCluster 的启动入口在 <code>LocalStreamEnvironment</code> 中。</p>

<p>在 <code>MiniCluster#start</code> 中，启动流程大致分为三个阶段：</p>

<ul>
<li>创建一些辅助的服务，如 <code>RpcService</code>， <code>HighAvailabilityServices</code>, <code>BlobServer</code> 等</li>
<li>启动 TaskManager</li>
<li>启动 Dispatcher， ResourceManager 等</li>
</ul>

<h3 id="创建-highavailabilityservices">创建 <code>HighAvailabilityServices</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nf">MiniCluster</span> <span class="p">{</span>
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">start</span><span class="p">()</span> <span class="p">{</span>
		<span class="c1">//......
</span><span class="c1"></span>		<span class="n">ioExecutor</span> <span class="o">=</span> <span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span>
					<span class="n">Hardware</span><span class="p">.</span><span class="na">getNumberCPUCores</span><span class="p">(),</span>
					<span class="k">new</span> <span class="n">ExecutorThreadFactory</span><span class="p">(</span><span class="s">&#34;mini-cluster-io&#34;</span><span class="p">));</span>
		<span class="n">haServices</span> <span class="o">=</span> <span class="n">createHighAvailabilityServices</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="n">ioExecutor</span><span class="p">);</span>
		<span class="c1">//......
</span><span class="c1"></span>	<span class="p">}</span>
	
	<span class="kd">protected</span> <span class="nf">HighAvailabilityServices</span> <span class="n">createHighAvailabilityServices</span><span class="p">(</span><span class="n">Configuration</span> <span class="nf">configuration</span><span class="p">,</span> <span class="n">Executor</span> <span class="nf">executor</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Starting high-availability services&#34;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HighAvailabilityServicesUtils</span><span class="p">.</span><span class="na">createAvailableOrEmbeddedServices</span><span class="p">(</span>
			<span class="n">configuration</span><span class="p">,</span>
			<span class="n">executor</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><code>HighAvailabilityServicesUtils</code> 是创建 <code>HighAvailabilityServices</code> 的工具类，在没有配置 HA 的情况下，会创建 <code>EmbeddedHaServices</code>。 <code>EmbeddedHaServices</code> 不具备高可用的特性，适用于 ResourceMangaer， TaksManager，JobManager 等所有组件都运行在同一个进程的情况。<code>EmbeddedHaService</code> 为各组件创建的选举服务为 <code>EmbeddedLeaderElectionService</code>, 一旦有参与选举的 <code>LeaderContender</code> 加入，该 contender 就被选择为 leader。</p>

<h3 id="启动-taskmanager">启动 TaskManager</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nf">MiniCluster</span> <span class="p">{</span>
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">start</span><span class="p">()</span> <span class="p">{</span>
		<span class="c1">//......
</span><span class="c1"></span>		<span class="n">startTaskManagers</span><span class="p">();</span>
		<span class="c1">//......
</span><span class="c1"></span>	<span class="p">}</span>

	<span class="kd">private</span> <span class="nf">void</span> <span class="n">startTaskManagers</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="kd">final</span> <span class="nf">int</span> <span class="n">numTaskManagers</span> <span class="o">=</span> <span class="n">miniClusterConfiguration</span><span class="p">.</span><span class="na">getNumTaskManagers</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nf">i</span> <span class="o">=</span> <span class="n">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numTaskManagers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">startTaskExecutor</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nd">@VisibleForTesting</span>
	<span class="kt">void</span> <span class="nf">startTaskExecutor</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="kd">synchronized</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">final</span> <span class="nf">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">miniClusterConfiguration</span><span class="p">.</span><span class="na">getConfiguration</span><span class="p">();</span>

			<span class="kd">final</span> <span class="nf">TaskExecutor</span> <span class="n">taskExecutor</span> <span class="o">=</span> <span class="n">TaskManagerRunner</span><span class="p">.</span><span class="na">startTaskManager</span><span class="p">(</span>
				<span class="n">configuration</span><span class="p">,</span>
				<span class="k">new</span> <span class="n">ResourceID</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">()),</span>
				<span class="n">taskManagerRpcServiceFactory</span><span class="p">.</span><span class="na">createRpcService</span><span class="p">(),</span>
				<span class="n">haServices</span><span class="p">,</span>
				<span class="n">heartbeatServices</span><span class="p">,</span>
				<span class="n">metricRegistry</span><span class="p">,</span>
				<span class="n">blobCacheService</span><span class="p">,</span>
				<span class="n">useLocalCommunication</span><span class="p">(),</span>
				<span class="n">taskManagerTerminatingFatalErrorHandlerFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">taskManagers</span><span class="p">.</span><span class="na">size</span><span class="p">()));</span>

			<span class="n">taskExecutor</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
			<span class="n">taskManagers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">taskExecutor</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在创建 <code>HighAvailabilityServices</code> 之后，就可以依次启动 TaskManager 了。<code>TaskManagerRunner#startTaskManager</code> 会创建一个 <code>TaskExecutor</code>,  <code>TaskExecutor</code> 实现了 <code>RpcEndpoint</code> 接口。 <code>TaskExecutor</code> 需要和 <code>ResourceManager</code> 等组件进行通信，可以通过 <code>HighAvailabilityServices</code> 获得对应的服务地址。</p>

<p>在 <code>TaskExecutor</code> 启动的回调函数中，会启动一系列服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nf">TaskExecutor</span> <span class="kd">extends</span> <span class="nf">RpcEndpoint</span> <span class="kd">implements</span> <span class="nf">TaskExecutorGateway</span> <span class="p">{</span>
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">onStart</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="c1">//启动服务
</span><span class="c1"></span>			<span class="n">startTaskExecutorServices</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">final</span> <span class="nf">TaskManagerException</span> <span class="n">exception</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TaskManagerException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;Could not start the TaskExecutor %s&#34;</span><span class="p">,</span> <span class="n">getAddress</span><span class="p">()),</span> <span class="n">e</span><span class="p">);</span>
			<span class="n">onFatalError</span><span class="p">(</span><span class="n">exception</span><span class="p">);</span>
			<span class="k">throw</span> <span class="n">exception</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="c1">//超时交由 FatalErrorHandler 进行处理
</span><span class="c1"></span>		<span class="n">startRegistrationTimeout</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="kd">private</span> <span class="nf">void</span> <span class="n">startTaskExecutorServices</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="c1">// start by connecting to the ResourceManager
</span><span class="c1"></span>			<span class="n">resourceManagerLeaderRetriever</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">new</span> <span class="n">ResourceManagerLeaderListener</span><span class="p">());</span>

			<span class="c1">// tell the task slot table who&#39;s responsible for the task slot actions
</span><span class="c1"></span>			<span class="n">taskSlotTable</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">new</span> <span class="n">SlotActionsImpl</span><span class="p">());</span>

			<span class="c1">// start the job leader service
</span><span class="c1"></span>			<span class="n">jobLeaderService</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">getAddress</span><span class="p">(),</span> <span class="n">getRpcService</span><span class="p">(),</span> <span class="n">haServices</span><span class="p">,</span> <span class="k">new</span> <span class="n">JobLeaderListenerImpl</span><span class="p">());</span>

			<span class="n">fileCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileCache</span><span class="p">(</span><span class="n">taskManagerConfiguration</span><span class="p">.</span><span class="na">getTmpDirectories</span><span class="p">(),</span> <span class="n">blobCacheService</span><span class="p">.</span><span class="na">getPermanentBlobService</span><span class="p">());</span>
		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handleStartTaskExecutorServicesException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="cm">/**
</span><span class="cm">	 * The listener for leader changes of the resource manager.
</span><span class="cm">	 */</span>
	<span class="kd">private</span> <span class="nf">final</span> <span class="kd">class</span> <span class="nf">ResourceManagerLeaderListener</span> <span class="kd">implements</span> <span class="nf">LeaderRetrievalListener</span> <span class="p">{</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nf">void</span> <span class="n">notifyLeaderAddress</span><span class="p">(</span><span class="kd">final</span> <span class="nf">String</span> <span class="n">leaderAddress</span><span class="p">,</span> <span class="kd">final</span> <span class="nf">UUID</span> <span class="n">leaderSessionID</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">//获得 ResourceManager 的地址， 和 ResourceManager 建立连接
</span><span class="c1"></span>			<span class="n">runAsync</span><span class="p">(</span>
				<span class="p">()</span> <span class="o">-&gt;</span> <span class="n">notifyOfNewResourceManagerLeader</span><span class="p">(</span>
					<span class="n">leaderAddress</span><span class="p">,</span>
					<span class="n">ResourceManagerId</span><span class="p">.</span><span class="na">fromUuidOrNull</span><span class="p">(</span><span class="n">leaderSessionID</span><span class="p">)));</span>
		<span class="p">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nf">void</span> <span class="n">handleError</span><span class="p">(</span><span class="n">Exception</span> <span class="nf">exception</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">onFatalError</span><span class="p">(</span><span class="n">exception</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="kd">private</span> <span class="nf">final</span> <span class="kd">class</span> <span class="nf">JobLeaderListenerImpl</span> <span class="kd">implements</span> <span class="nf">JobLeaderListener</span> <span class="p">{</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nf">void</span> <span class="n">jobManagerGainedLeadership</span><span class="p">(</span>
			<span class="kd">final</span> <span class="nf">JobID</span> <span class="n">jobId</span><span class="p">,</span>
			<span class="kd">final</span> <span class="nf">JobMasterGateway</span> <span class="n">jobManagerGateway</span><span class="p">,</span>
			<span class="kd">final</span> <span class="nf">JMTMRegistrationSuccess</span> <span class="n">registrationMessage</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">//和 JobManager 建立连接
</span><span class="c1"></span>			<span class="n">runAsync</span><span class="p">(</span>
				<span class="p">()</span> <span class="o">-&gt;</span>
					<span class="n">establishJobManagerConnection</span><span class="p">(</span>
						<span class="n">jobId</span><span class="p">,</span>
						<span class="n">jobManagerGateway</span><span class="p">,</span>
						<span class="n">registrationMessage</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nf">void</span> <span class="n">jobManagerLostLeadership</span><span class="p">(</span><span class="kd">final</span> <span class="nf">JobID</span> <span class="n">jobId</span><span class="p">,</span> <span class="kd">final</span> <span class="nf">JobMasterId</span> <span class="n">jobMasterId</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;JobManager for job {} with leader id {} lost leadership.&#34;</span><span class="p">,</span> <span class="n">jobId</span><span class="p">,</span> <span class="n">jobMasterId</span><span class="p">);</span>

			<span class="n">runAsync</span><span class="p">(()</span> <span class="o">-&gt;</span>
				<span class="n">closeJobManagerConnection</span><span class="p">(</span>
					<span class="n">jobId</span><span class="p">,</span>
					<span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&#34;Job leader for job id &#34;</span> <span class="o">+</span> <span class="n">jobId</span> <span class="o">+</span> <span class="s">&#34; lost leadership.&#34;</span><span class="p">)));</span>
		<span class="p">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nf">void</span> <span class="n">handleError</span><span class="p">(</span><span class="n">Throwable</span> <span class="nf">throwable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">onFatalError</span><span class="p">(</span><span class="n">throwable</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>当 <code>ResourceManagerLeaderListener</code> 的监听被回调时，<code>TaskExecutor</code> 会试图建立和 <code>ResourceManager</code> 的连接，连接被封装为 <code>TaskExecutorToResourceManagerConnection</code>。一旦获取 <code>ResourceManager</code> 的 leader 被确定后，就可以获取到 <code>ResourceManager</code> 对应的 RpcGateway， 接下来就可以通过 RPC 调用发起 <code>ResourceManager#registerTaskExecutor</code> 注册流程。注册成功后，<code>TaskExecutor</code> 向 <code>ResourceManager</code> 报告其资源（主要是 slots）情况。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nf">TaskExecutor</span> <span class="p">{</span>
	<span class="kd">private</span> <span class="nf">void</span> <span class="n">establishResourceManagerConnection</span><span class="p">(</span>
			<span class="n">ResourceManagerGateway</span> <span class="nf">resourceManagerGateway</span><span class="p">,</span>
			<span class="n">ResourceID</span> <span class="nf">resourceManagerResourceId</span><span class="p">,</span>
			<span class="n">InstanceID</span> <span class="nf">taskExecutorRegistrationId</span><span class="p">,</span>
			<span class="n">ClusterInformation</span> <span class="nf">clusterInformation</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//发送SlotReport
</span><span class="c1"></span>		<span class="kd">final</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">Acknowledge</span><span class="o">&gt;</span> <span class="nf">slotReportResponseFuture</span> <span class="o">=</span> <span class="n">resourceManagerGateway</span><span class="p">.</span><span class="na">sendSlotReport</span><span class="p">(</span>
			<span class="n">getResourceID</span><span class="p">(),</span>
			<span class="n">taskExecutorRegistrationId</span><span class="p">,</span>
			<span class="n">taskSlotTable</span><span class="p">.</span><span class="na">createSlotReport</span><span class="p">(</span><span class="n">getResourceID</span><span class="p">()),</span>
			<span class="n">taskManagerConfiguration</span><span class="p">.</span><span class="na">getTimeout</span><span class="p">());</span>
		<span class="c1">//......
</span><span class="c1"></span>		<span class="c1">//连接建立
</span><span class="c1"></span>		<span class="n">establishedResourceManagerConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EstablishedResourceManagerConnection</span><span class="p">(</span>
			<span class="n">resourceManagerGateway</span><span class="p">,</span>
			<span class="n">resourceManagerResourceId</span><span class="p">,</span>
			<span class="n">taskExecutorRegistrationId</span><span class="p">);</span>

		<span class="n">stopRegistrationTimeout</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="启动-dispatcherresourcemanagercomponent">启动 <code>DispatcherResourceManagerComponent</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nf">MiniCluster</span> <span class="p">{</span>
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">start</span><span class="p">()</span> <span class="p">{</span>
		<span class="c1">//......
</span><span class="c1"></span>		<span class="n">dispatcherResourceManagerComponents</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">createDispatcherResourceManagerComponents</span><span class="p">(</span>
					<span class="n">configuration</span><span class="p">,</span>
					<span class="n">dispatcherResourceManagreComponentRpcServiceFactory</span><span class="p">,</span>
					<span class="n">haServices</span><span class="p">,</span>
					<span class="n">blobServer</span><span class="p">,</span>
					<span class="n">heartbeatServices</span><span class="p">,</span>
					<span class="n">metricRegistry</span><span class="p">,</span>
					<span class="n">metricQueryServiceRetriever</span><span class="p">,</span>
					<span class="k">new</span> <span class="n">ShutDownFatalErrorHandler</span><span class="p">()</span>
				<span class="p">));</span>
		<span class="c1">//......
</span><span class="c1"></span>	<span class="p">}</span>

	<span class="kd">protected</span> <span class="nf">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nf">DispatcherResourceManagerComponent</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">createDispatcherResourceManagerComponents</span><span class="p">(</span>
			<span class="n">Configuration</span> <span class="nf">configuration</span><span class="p">,</span>
			<span class="n">RpcServiceFactory</span> <span class="nf">rpcServiceFactory</span><span class="p">,</span>
			<span class="n">HighAvailabilityServices</span> <span class="nf">haServices</span><span class="p">,</span>
			<span class="n">BlobServer</span> <span class="nf">blobServer</span><span class="p">,</span>
			<span class="n">HeartbeatServices</span> <span class="nf">heartbeatServices</span><span class="p">,</span>
			<span class="n">MetricRegistry</span> <span class="nf">metricRegistry</span><span class="p">,</span>
			<span class="n">MetricQueryServiceRetriever</span> <span class="nf">metricQueryServiceRetriever</span><span class="p">,</span>
			<span class="n">FatalErrorHandler</span> <span class="nf">fatalErrorHandler</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
	   <span class="c1">//Session dispatcher, standalone resource manager
</span><span class="c1"></span>		<span class="n">SessionDispatcherResourceManagerComponentFactory</span> <span class="nf">dispatcherResourceManagerComponentFactory</span> <span class="o">=</span> <span class="n">createDispatcherResourceManagerComponentFactory</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">Collections</span><span class="p">.</span><span class="na">singleton</span><span class="p">(</span>
			<span class="n">dispatcherResourceManagerComponentFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
				<span class="n">configuration</span><span class="p">,</span>
				<span class="n">rpcServiceFactory</span><span class="p">.</span><span class="na">createRpcService</span><span class="p">(),</span>
				<span class="n">haServices</span><span class="p">,</span>
				<span class="n">blobServer</span><span class="p">,</span>
				<span class="n">heartbeatServices</span><span class="p">,</span>
				<span class="n">metricRegistry</span><span class="p">,</span>
				<span class="k">new</span> <span class="n">MemoryArchivedExecutionGraphStore</span><span class="p">(),</span>
				<span class="n">metricQueryServiceRetriever</span><span class="p">,</span>
				<span class="n">fatalErrorHandler</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="nd">@Nonnull</span>
	<span class="kd">private</span> <span class="nf">SessionDispatcherResourceManagerComponentFactory</span> <span class="n">createDispatcherResourceManagerComponentFactory</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="n">SessionDispatcherResourceManagerComponentFactory</span><span class="p">(</span><span class="n">StandaloneResourceManagerFactory</span><span class="p">.</span><span class="na">INSTANCE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在 MiniCluster 模式下，会创建一个 <code>SessionDispatcherResourceManagerComponent</code> 对象。<code>SessionDispatcherResourceManagerComponent</code> 继承自 <code>DispatcherResourceManagerComponent</code>，用来启动 Dispatcher， ResourceManager，和 WebMonitorEndpoint， 这些组件都在同一个进程中运行。MiniCluster 模式下启动的是 <code>StandaloneDispatcher</code> 和 <code>StandaloneResourceManager</code>。</p>

<p>在工厂类创建 <code>DispatcherResourceManagerComponent</code>, 会启动 Dispatcher， ResourceManager 等组件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">abstract</span> <span class="kd">class</span> <span class="nf">AbstractDispatcherResourceManagerComponentFactory</span><span class="o">&lt;</span><span class="n">T</span> <span class="nf">extends</span> <span class="n">Dispatcher</span><span class="p">,</span> <span class="n">U</span> <span class="nf">extends</span> <span class="n">RestfulGateway</span><span class="o">&gt;</span> <span class="nf">implements</span> <span class="n">DispatcherResourceManagerComponentFactory</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nf">DispatcherResourceManagerComponent</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">create</span><span class="p">(</span>
			<span class="n">Configuration</span> <span class="nf">configuration</span><span class="p">,</span>
			<span class="n">RpcService</span> <span class="nf">rpcService</span><span class="p">,</span>
			<span class="n">HighAvailabilityServices</span> <span class="nf">highAvailabilityServices</span><span class="p">,</span>
			<span class="n">BlobServer</span> <span class="nf">blobServer</span><span class="p">,</span>
			<span class="n">HeartbeatServices</span> <span class="nf">heartbeatServices</span><span class="p">,</span>
			<span class="n">MetricRegistry</span> <span class="nf">metricRegistry</span><span class="p">,</span>
			<span class="n">ArchivedExecutionGraphStore</span> <span class="nf">archivedExecutionGraphStore</span><span class="p">,</span>
			<span class="n">MetricQueryServiceRetriever</span> <span class="nf">metricQueryServiceRetriever</span><span class="p">,</span>
			<span class="n">FatalErrorHandler</span> <span class="nf">fatalErrorHandler</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="c1">//.......
</span><span class="c1"></span>
		<span class="n">webMonitorEndpoint</span> <span class="o">=</span> <span class="n">restEndpointFactory</span><span class="p">.</span><span class="na">createRestEndpoint</span><span class="p">(</span>
				<span class="n">configuration</span><span class="p">,</span>
				<span class="n">dispatcherGatewayRetriever</span><span class="p">,</span>
				<span class="n">resourceManagerGatewayRetriever</span><span class="p">,</span>
				<span class="n">blobServer</span><span class="p">,</span>
				<span class="n">executor</span><span class="p">,</span>
				<span class="n">metricFetcher</span><span class="p">,</span>
				<span class="n">highAvailabilityServices</span><span class="p">.</span><span class="na">getWebMonitorLeaderElectionService</span><span class="p">(),</span>
				<span class="n">fatalErrorHandler</span><span class="p">);</span>

		<span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;Starting Dispatcher REST endpoint.&#34;</span><span class="p">);</span>
		<span class="n">webMonitorEndpoint</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
	
		<span class="n">resourceManager</span> <span class="o">=</span> <span class="n">resourceManagerFactory</span><span class="p">.</span><span class="na">createResourceManager</span><span class="p">(</span>
				<span class="n">configuration</span><span class="p">,</span>
				<span class="n">ResourceID</span><span class="p">.</span><span class="na">generate</span><span class="p">(),</span>
				<span class="n">rpcService</span><span class="p">,</span>
				<span class="n">highAvailabilityServices</span><span class="p">,</span>
				<span class="n">heartbeatServices</span><span class="p">,</span>
				<span class="n">metricRegistry</span><span class="p">,</span>
				<span class="n">fatalErrorHandler</span><span class="p">,</span>
				<span class="k">new</span> <span class="n">ClusterInformation</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">blobServer</span><span class="p">.</span><span class="na">getPort</span><span class="p">()),</span>
				<span class="n">webMonitorEndpoint</span><span class="p">.</span><span class="na">getRestBaseUrl</span><span class="p">(),</span>
				<span class="n">jobManagerMetricGroup</span><span class="p">);</span>

		<span class="kd">final</span> <span class="nf">HistoryServerArchivist</span> <span class="n">historyServerArchivist</span> <span class="o">=</span> <span class="n">HistoryServerArchivist</span><span class="p">.</span><span class="na">createHistoryServerArchivist</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="n">webMonitorEndpoint</span><span class="p">);</span>

		<span class="n">dispatcher</span> <span class="o">=</span> <span class="n">dispatcherFactory</span><span class="p">.</span><span class="na">createDispatcher</span><span class="p">(</span>
				<span class="n">configuration</span><span class="p">,</span>
				<span class="n">rpcService</span><span class="p">,</span>
				<span class="n">highAvailabilityServices</span><span class="p">,</span>
				<span class="n">resourceManagerGatewayRetriever</span><span class="p">,</span>
				<span class="n">blobServer</span><span class="p">,</span>
				<span class="n">heartbeatServices</span><span class="p">,</span>
				<span class="n">jobManagerMetricGroup</span><span class="p">,</span>
				<span class="n">metricRegistry</span><span class="p">.</span><span class="na">getMetricQueryServiceGatewayRpcAddress</span><span class="p">(),</span>
				<span class="n">archivedExecutionGraphStore</span><span class="p">,</span>
				<span class="n">fatalErrorHandler</span><span class="p">,</span>
				<span class="n">historyServerArchivist</span><span class="p">);</span>

		<span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;Starting ResourceManager.&#34;</span><span class="p">);</span>
		<span class="n">resourceManager</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
		<span class="n">resourceManagerRetrievalService</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">resourceManagerGatewayRetriever</span><span class="p">);</span>

		<span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;Starting Dispatcher.&#34;</span><span class="p">);</span>
		<span class="n">dispatcher</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
		<span class="n">dispatcherLeaderRetrievalService</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">dispatcherGatewayRetriever</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">createDispatcherResourceManagerComponent</span><span class="p">(</span>
				<span class="n">dispatcher</span><span class="p">,</span>
				<span class="n">resourceManager</span><span class="p">,</span>
				<span class="n">dispatcherLeaderRetrievalService</span><span class="p">,</span>
				<span class="n">resourceManagerRetrievalService</span><span class="p">,</span>
				<span class="n">webMonitorEndpoint</span><span class="p">,</span>
				<span class="n">jobManagerMetricGroup</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在 <code>ResourceManager</code> 启动的回调函数中，会通过 <code>HighAvailabilityServices</code> 获取到选举服务，从而参与到选举之中。并启动 <code>JobLeaderIdService</code>，管理向当前 ResourceManager 注册的作业的 leader id。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">abstract</span> <span class="nf">class</span> <span class="n">ResourceManager</span><span class="o">&lt;</span><span class="n">WorkerType</span> <span class="nf">extends</span> <span class="n">ResourceIDRetrievable</span><span class="o">&gt;</span>
		<span class="nf">extends</span> <span class="n">FencedRpcEndpoint</span><span class="o">&lt;</span><span class="n">ResourceManagerId</span><span class="o">&gt;</span>
		<span class="nf">implements</span> <span class="n">ResourceManagerGateway</span><span class="p">,</span> <span class="n">LeaderContender</span> <span class="p">{</span>
		<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">onStart</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="n">startResourceManagerServices</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">final</span> <span class="nf">ResourceManagerException</span> <span class="n">exception</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceManagerException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;Could not start the ResourceManager %s&#34;</span><span class="p">,</span> <span class="n">getAddress</span><span class="p">()),</span> <span class="n">e</span><span class="p">);</span>
			<span class="n">onFatalError</span><span class="p">(</span><span class="n">exception</span><span class="p">);</span>
			<span class="k">throw</span> <span class="n">exception</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kd">private</span> <span class="nf">void</span> <span class="n">startResourceManagerServices</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="n">leaderElectionService</span> <span class="o">=</span> <span class="n">highAvailabilityServices</span><span class="p">.</span><span class="na">getResourceManagerLeaderElectionService</span><span class="p">();</span>

			<span class="n">initialize</span><span class="p">();</span>
			<span class="c1">//参与选举
</span><span class="c1"></span>			<span class="n">leaderElectionService</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
			<span class="n">jobLeaderIdService</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">new</span> <span class="n">JobLeaderIdActionsImpl</span><span class="p">());</span>

			<span class="n">registerSlotAndTaskExecutorMetrics</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handleStartResourceManagerServicesException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在 <code>Dispatcher</code> 启动的回调函数中，当前 Dispatcher 也会通过 <code>LeaderElectionService</code> 参与选举。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">abstract</span> <span class="kd">class</span> <span class="nf">Dispatcher</span> <span class="kd">extends</span> <span class="nf">FencedRpcEndpoint</span><span class="o">&lt;</span><span class="n">DispatcherId</span><span class="o">&gt;</span> <span class="nf">implements</span>
	<span class="n">DispatcherGateway</span><span class="p">,</span> <span class="n">LeaderContender</span><span class="p">,</span> <span class="n">SubmittedJobGraphStore</span><span class="p">.</span><span class="na">SubmittedJobGraphListener</span> <span class="p">{</span>
	<span class="c1">//resource manager 的 gateway retriever，可以和 resource manager 通信
</span><span class="c1"></span>	<span class="kd">private</span> <span class="nf">final</span> <span class="n">GatewayRetriever</span><span class="o">&lt;</span><span class="n">ResourceManagerGateway</span><span class="o">&gt;</span> <span class="nf">resourceManagerGatewayRetriever</span><span class="p">;</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">onStart</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="n">startDispatcherServices</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">final</span> <span class="nf">DispatcherException</span> <span class="n">exception</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DispatcherException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;Could not start the Dispatcher %s&#34;</span><span class="p">,</span> <span class="n">getAddress</span><span class="p">()),</span> <span class="n">e</span><span class="p">);</span>
			<span class="n">onFatalError</span><span class="p">(</span><span class="n">exception</span><span class="p">);</span>
			<span class="k">throw</span> <span class="n">exception</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kd">private</span> <span class="nf">void</span> <span class="n">startDispatcherServices</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="n">submittedJobGraphStore</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
			<span class="n">leaderElectionService</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

			<span class="n">registerDispatcherMetrics</span><span class="p">(</span><span class="n">jobManagerMetricGroup</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handleStartDispatcherServicesException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="提交-jobgraph">提交 JobGraph</h3>

<p>通过 <code>MiniCluster#executeJobBlocking</code> 提交 <code>JobGraph</code> 并等待运行完成，提交<code>JobGraph</code>和请求运行结果的逻辑如下，都是通过 RPC 调用来实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nf">MiniCluster</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobSubmissionResult</span><span class="o">&gt;</span> <span class="nf">submitJob</span><span class="p">(</span><span class="n">JobGraph</span> <span class="nf">jobGraph</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">//通过 Dispatcher 的 gateway retriever 获取 DispatcherGateway
</span><span class="c1"></span>		<span class="kd">final</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">DispatcherGateway</span><span class="o">&gt;</span> <span class="nf">dispatcherGatewayFuture</span> <span class="o">=</span> <span class="n">getDispatcherGatewayFuture</span><span class="p">();</span>

		<span class="c1">// we have to allow queued scheduling in Flip-6 mode because we need to request slots
</span><span class="c1"></span>		<span class="c1">// from the ResourceManager
</span><span class="c1"></span>		<span class="n">jobGraph</span><span class="p">.</span><span class="na">setAllowQueuedScheduling</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

		<span class="kd">final</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">InetSocketAddress</span><span class="o">&gt;</span> <span class="nf">blobServerAddressFuture</span> <span class="o">=</span> <span class="n">createBlobServerAddress</span><span class="p">(</span><span class="n">dispatcherGatewayFuture</span><span class="p">);</span>

		<span class="kd">final</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">jarUploadFuture</span> <span class="o">=</span> <span class="n">uploadAndSetJobFiles</span><span class="p">(</span><span class="n">blobServerAddressFuture</span><span class="p">,</span> <span class="n">jobGraph</span><span class="p">);</span>

		<span class="c1">//通过 RPC 调用向 Dispatcher 提交 JobGraph
</span><span class="c1"></span>		<span class="kd">final</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">Acknowledge</span><span class="o">&gt;</span> <span class="nf">acknowledgeCompletableFuture</span> <span class="o">=</span> <span class="n">jarUploadFuture</span>
			<span class="p">.</span><span class="na">thenCombine</span><span class="p">(</span>
				<span class="n">dispatcherGatewayFuture</span><span class="p">,</span>
				<span class="p">(</span><span class="n">Void</span> <span class="nf">ack</span><span class="p">,</span> <span class="n">DispatcherGateway</span> <span class="nf">dispatcherGateway</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dispatcherGateway</span><span class="p">.</span><span class="na">submitJob</span><span class="p">(</span><span class="n">jobGraph</span><span class="p">,</span> <span class="n">rpcTimeout</span><span class="p">))</span>
			<span class="p">.</span><span class="na">thenCompose</span><span class="p">(</span><span class="n">Function</span><span class="p">.</span><span class="na">identity</span><span class="p">());</span>

		<span class="k">return</span> <span class="n">acknowledgeCompletableFuture</span><span class="p">.</span><span class="na">thenApply</span><span class="p">(</span>
			<span class="p">(</span><span class="n">Acknowledge</span> <span class="nf">ignored</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">JobSubmissionResult</span><span class="p">(</span><span class="n">jobGraph</span><span class="p">.</span><span class="na">getJobID</span><span class="p">()));</span>
	<span class="p">}</span>

	<span class="kd">public</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobResult</span><span class="o">&gt;</span> <span class="nf">requestJobResult</span><span class="p">(</span><span class="n">JobID</span> <span class="nf">jobId</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">runDispatcherCommand</span><span class="p">(</span><span class="n">dispatcherGateway</span> <span class="o">-&gt;</span> <span class="n">dispatcherGateway</span><span class="p">.</span><span class="na">requestJobResult</span><span class="p">(</span><span class="n">jobId</span><span class="p">,</span> <span class="n">RpcUtils</span><span class="p">.</span><span class="na">INF_TIMEOUT</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><code>Dispatcher</code> 在接收到提交 <code>JobGraph</code> 的请求后，会将提交的 <code>JobGraph</code> 保存在 <code>SubmittedJobGraphStore</code> 中（用于故障恢复），并为提交的 <code>JobGraph</code> 启动 JobManager：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nf">Dispatcher</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobManagerRunner</span><span class="o">&gt;</span> <span class="nf">createJobManagerRunner</span><span class="p">(</span><span class="n">JobGraph</span> <span class="nf">jobGraph</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">final</span> <span class="nf">RpcService</span> <span class="n">rpcService</span> <span class="o">=</span> <span class="n">getRpcService</span><span class="p">();</span>

		<span class="c1">//创建 JobManagerRunner
</span><span class="c1"></span>		<span class="kd">final</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobManagerRunner</span><span class="o">&gt;</span> <span class="nf">jobManagerRunnerFuture</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(</span>
			<span class="n">CheckedSupplier</span><span class="p">.</span><span class="na">unchecked</span><span class="p">(()</span> <span class="o">-&gt;</span>
				<span class="n">jobManagerRunnerFactory</span><span class="p">.</span><span class="na">createJobManagerRunner</span><span class="p">(</span>
					<span class="n">jobGraph</span><span class="p">,</span>
					<span class="n">configuration</span><span class="p">,</span>
					<span class="n">rpcService</span><span class="p">,</span>
					<span class="n">highAvailabilityServices</span><span class="p">,</span>
					<span class="n">heartbeatServices</span><span class="p">,</span>
					<span class="n">jobManagerSharedServices</span><span class="p">,</span>
					<span class="k">new</span> <span class="n">DefaultJobManagerJobMetricGroupFactory</span><span class="p">(</span><span class="n">jobManagerMetricGroup</span><span class="p">),</span>
					<span class="n">fatalErrorHandler</span><span class="p">)),</span>
			<span class="n">rpcService</span><span class="p">.</span><span class="na">getExecutor</span><span class="p">());</span>

		<span class="k">return</span> <span class="n">jobManagerRunnerFuture</span><span class="p">.</span><span class="na">thenApply</span><span class="p">(</span><span class="n">FunctionUtils</span><span class="p">.</span><span class="na">uncheckedFunction</span><span class="p">(</span><span class="k">this</span><span class="o">::</span><span class="n">startJobManagerRunner</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="kd">private</span> <span class="nf">JobManagerRunner</span> <span class="n">startJobManagerRunner</span><span class="p">(</span><span class="n">JobManagerRunner</span> <span class="nf">jobManagerRunner</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="kd">final</span> <span class="nf">JobID</span> <span class="n">jobId</span> <span class="o">=</span> <span class="n">jobManagerRunner</span><span class="p">.</span><span class="na">getJobGraph</span><span class="p">().</span><span class="na">getJobID</span><span class="p">();</span>
		<span class="n">jobManagerRunner</span><span class="p">.</span><span class="na">getResultFuture</span><span class="p">().</span><span class="na">whenCompleteAsync</span><span class="p">(</span>
			<span class="p">(</span><span class="n">ArchivedExecutionGraph</span> <span class="nf">archivedExecutionGraph</span><span class="p">,</span> <span class="n">Throwable</span> <span class="nf">throwable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
				<span class="c1">// check if we are still the active JobManagerRunner by checking the identity
</span><span class="c1"></span>				<span class="c1">//noinspection ObjectEquality
</span><span class="c1"></span>				<span class="k">if</span> <span class="p">(</span><span class="n">jobManagerRunner</span> <span class="o">==</span> <span class="n">jobManagerRunnerFutures</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">jobId</span><span class="p">).</span><span class="na">getNow</span><span class="p">(</span><span class="kc">null</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">archivedExecutionGraph</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">jobReachedGloballyTerminalState</span><span class="p">(</span><span class="n">archivedExecutionGraph</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="kd">final</span> <span class="nf">Throwable</span> <span class="n">strippedThrowable</span> <span class="o">=</span> <span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">stripCompletionException</span><span class="p">(</span><span class="n">throwable</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">strippedThrowable</span> <span class="nf">instanceof</span> <span class="n">JobNotFinishedException</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">jobNotFinished</span><span class="p">(</span><span class="n">jobId</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">jobMasterFailed</span><span class="p">(</span><span class="n">jobId</span><span class="p">,</span> <span class="n">strippedThrowable</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;There is a newer JobManagerRunner for the job {}.&#34;</span><span class="p">,</span> <span class="n">jobId</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">},</span> <span class="n">getMainThreadExecutor</span><span class="p">());</span>

		<span class="c1">//启动JobManager
</span><span class="c1"></span>		<span class="n">jobManagerRunner</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>

		<span class="k">return</span> <span class="n">jobManagerRunner</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>启动的 <code>JobManagerRunner</code> 会竞争 leader ，一旦被选举为 leader，就会启动一个 <code>JobMaster</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">JobManagerRunner</span> <span class="nf">implements</span> <span class="n">LeaderContender</span><span class="p">,</span> <span class="n">OnCompletionActions</span><span class="p">,</span> <span class="n">AutoCloseableAsync</span> <span class="p">{</span>
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">start</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="c1">//竞争leader
</span><span class="c1"></span>			<span class="n">leaderElectionService</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;Could not start the JobManager because the leader election service did not start.&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&#34;Could not start the leader election service.&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="c1">//被选举为 leader
</span><span class="c1"></span>	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">grantLeadership</span><span class="p">(</span><span class="kd">final</span> <span class="nf">UUID</span> <span class="n">leaderSessionID</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">synchronized</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">shutdown</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;JobManagerRunner already shutdown.&#34;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">leadershipOperation</span> <span class="o">=</span> <span class="n">leadershipOperation</span><span class="p">.</span><span class="na">thenCompose</span><span class="p">(</span>
				<span class="p">(</span><span class="n">ignored</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
					<span class="kd">synchronized</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="n">verifyJobSchedulingStatusAndStartJobManager</span><span class="p">(</span><span class="n">leaderSessionID</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">});</span>

			<span class="n">handleException</span><span class="p">(</span><span class="n">leadershipOperation</span><span class="p">,</span> <span class="s">&#34;Could not start the job manager.&#34;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kd">private</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">verifyJobSchedulingStatusAndStartJobManager</span><span class="p">(</span><span class="n">UUID</span> <span class="nf">leaderSessionId</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">final</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobSchedulingStatus</span><span class="o">&gt;</span> <span class="nf">jobSchedulingStatusFuture</span> <span class="o">=</span> <span class="n">getJobSchedulingStatus</span><span class="p">();</span>

		<span class="k">return</span> <span class="n">jobSchedulingStatusFuture</span><span class="p">.</span><span class="na">thenCompose</span><span class="p">(</span>
			<span class="n">jobSchedulingStatus</span> <span class="o">-&gt;</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">jobSchedulingStatus</span> <span class="o">==</span> <span class="n">JobSchedulingStatus</span><span class="p">.</span><span class="na">DONE</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="n">jobAlreadyDone</span><span class="p">();</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">return</span> <span class="n">startJobMaster</span><span class="p">(</span><span class="n">leaderSessionId</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">});</span>
	<span class="p">}</span>

	<span class="kd">private</span> <span class="nf">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">startJobMaster</span><span class="p">(</span><span class="n">UUID</span> <span class="nf">leaderSessionId</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;JobManager runner for job {} ({}) was granted leadership with session id {} at {}.&#34;</span><span class="p">,</span>
			<span class="n">jobGraph</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span> <span class="n">jobGraph</span><span class="p">.</span><span class="na">getJobID</span><span class="p">(),</span> <span class="n">leaderSessionId</span><span class="p">,</span> <span class="n">getAddress</span><span class="p">());</span>

		<span class="k">try</span> <span class="p">{</span>
			<span class="n">runningJobsRegistry</span><span class="p">.</span><span class="na">setJobRunning</span><span class="p">(</span><span class="n">jobGraph</span><span class="p">.</span><span class="na">getJobID</span><span class="p">());</span>
		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">FutureUtils</span><span class="p">.</span><span class="na">completedExceptionally</span><span class="p">(</span>
				<span class="k">new</span> <span class="n">FlinkException</span><span class="p">(</span>
					<span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;Failed to set the job %s to running in the running jobs registry.&#34;</span><span class="p">,</span> <span class="n">jobGraph</span><span class="p">.</span><span class="na">getJobID</span><span class="p">()),</span>
					<span class="n">e</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="kd">final</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">Acknowledge</span><span class="o">&gt;</span> <span class="nf">startFuture</span><span class="p">;</span>
		<span class="k">try</span> <span class="p">{</span>
		  <span class="c1">//使用特定的 JobMasterId 启动 JobMaster
</span><span class="c1"></span>			<span class="n">startFuture</span> <span class="o">=</span> <span class="n">jobMasterService</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">new</span> <span class="n">JobMasterId</span><span class="p">(</span><span class="n">leaderSessionId</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">FutureUtils</span><span class="p">.</span><span class="na">completedExceptionally</span><span class="p">(</span><span class="k">new</span> <span class="n">FlinkException</span><span class="p">(</span><span class="s">&#34;Failed to start the JobMaster.&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="kd">final</span> <span class="nf">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobMasterGateway</span><span class="o">&gt;</span> <span class="nf">currentLeaderGatewayFuture</span> <span class="o">=</span> <span class="n">leaderGatewayFuture</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">startFuture</span><span class="p">.</span><span class="na">thenAcceptAsync</span><span class="p">(</span>
			<span class="p">(</span><span class="n">Acknowledge</span> <span class="nf">ack</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">confirmLeaderSessionIdIfStillLeader</span><span class="p">(</span><span class="n">leaderSessionId</span><span class="p">,</span> <span class="n">currentLeaderGatewayFuture</span><span class="p">),</span>
			<span class="n">executor</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><code>JobMaster</code> 启动后会和 <code>ResourceManager</code> 建立连接，连接被封装为 <code>ResourceManagerConnection</code>。一旦连接建立之后，<code>JobMaster</code> 就可以通过 RPC 调用和 <code>ResourceManager</code> 进行通信了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">JobMaster</span> <span class="nf">extends</span> <span class="n">FencedRpcEndpoint</span><span class="o">&lt;</span><span class="n">JobMasterId</span><span class="o">&gt;</span> <span class="nf">implements</span> <span class="n">JobMasterGateway</span><span class="p">,</span> <span class="n">JobMasterService</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="nf">void</span> <span class="n">startJobMasterServices</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="c1">// start the slot pool make sure the slot pool now accepts messages for this leader
</span><span class="c1"></span>		<span class="n">slotPool</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">getFencingToken</span><span class="p">(),</span> <span class="n">getAddress</span><span class="p">(),</span> <span class="n">getMainThreadExecutor</span><span class="p">());</span>
		<span class="n">scheduler</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">getMainThreadExecutor</span><span class="p">());</span>

		<span class="c1">//TODO: Remove once the ZooKeeperLeaderRetrieval returns the stored address upon start
</span><span class="c1"></span>		<span class="c1">// try to reconnect to previously known leader
</span><span class="c1"></span>		<span class="n">reconnectToResourceManager</span><span class="p">(</span><span class="k">new</span> <span class="n">FlinkException</span><span class="p">(</span><span class="s">&#34;Starting JobMaster component.&#34;</span><span class="p">));</span>

		<span class="c1">// job is ready to go, try to establish connection with resource manager
</span><span class="c1"></span>		<span class="c1">//   - activate leader retrieval for the resource manager
</span><span class="c1"></span>		<span class="c1">//   - on notification of the leader, the connection will be established and
</span><span class="c1"></span>		<span class="c1">//     the slot pool will start requesting slots
</span><span class="c1"></span>		<span class="n">resourceManagerLeaderRetriever</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">new</span> <span class="n">ResourceManagerLeaderListener</span><span class="p">());</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在此之后就进入了任务调度执行的流程。</p>

<h2 id="standalone-cluster-模式的启动流程">Standalone Cluster 模式的启动流程</h2>

<p>在 Standalone 模式下，TaskManager 和 ResourceManager 等都在独立的进程中运行。Standalone Cluster 有两种启动方式， 即 standalonesession 模式和 standalonejob 方式，它们区别在于 Dispatcher 的实现方式不同。</p>

<h3 id="jobmanager-的启动">JobManager 的启动</h3>

<p>需要注意的一点是，这里我们所说的 <strong>JobManager</strong> 指的是包含 <code>Dispatcher</code>， <code>ResouceManager</code> 等组件的单一进程，而并非 <code>Dispatcher</code> 为执行 <code>JobGraph</code> 而启动的 <code>JobManagerRunner</code>。在 FLIP-6 的实现中，每个 <code>JobGraph</code> 的调度执行的实际上是由一个独立的 <code>JobMaster</code> 负责的。</p>

<p>standalonesession 方式启动的 JobManager 的入口类是 <code>StandaloneSessionClusterEntrypoint</code>， 继承自 <code>SessionClusterEntrypoint</code>；与此对应的是，以 standalonejob 方式启动 JobManager 的入口类是 <code>StandaloneJobClusterEntryPoint</code>，继承自 <code>JobClusterEntrypoint</code>。它们都由公共父类 <code>ClusterEntrypoint</code> 派生而来，区别在于生成的 <code>DispatcherResourceManagerComponent</code> 不同。</p>

<p>先来看下启动过程，实际上和 MiniCluster 模式下启动 <code>DispatcherResourceManagerComponent</code> 的过程类似：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">abstract</span> <span class="nf">class</span> <span class="n">ClusterEntrypoint</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="nf">void</span> <span class="n">runCluster</span><span class="p">(</span><span class="n">Configuration</span> <span class="nf">configuration</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="kd">synchronized</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		
			<span class="c1">//初始化 RpcService， HighAvailabilityServices  等服务
</span><span class="c1"></span>			<span class="n">initializeServices</span><span class="p">(</span><span class="n">configuration</span><span class="p">);</span>

			<span class="c1">// write host information into configuration
</span><span class="c1"></span>			<span class="n">configuration</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="n">JobManagerOptions</span><span class="p">.</span><span class="na">ADDRESS</span><span class="p">,</span> <span class="n">commonRpcService</span><span class="p">.</span><span class="na">getAddress</span><span class="p">());</span>
			<span class="n">configuration</span><span class="p">.</span><span class="na">setInteger</span><span class="p">(</span><span class="n">JobManagerOptions</span><span class="p">.</span><span class="na">PORT</span><span class="p">,</span> <span class="n">commonRpcService</span><span class="p">.</span><span class="na">getPort</span><span class="p">());</span>

			<span class="c1">//生成 DispatcherResourceManagerComponentFactory，由具体子类实现
</span><span class="c1"></span>			<span class="kd">final</span> <span class="nf">DispatcherResourceManagerComponentFactory</span><span class="o">&lt;?&gt;</span> <span class="n">dispatcherResourceManagerComponentFactory</span> <span class="o">=</span> <span class="n">createDispatcherResourceManagerComponentFactory</span><span class="p">(</span><span class="n">configuration</span><span class="p">);</span>

			<span class="c1">//创建 DispatcherResourceManagerComponent， 启动 ResourceManager， Dispatcher
</span><span class="c1"></span>			<span class="n">clusterComponent</span> <span class="o">=</span> <span class="n">dispatcherResourceManagerComponentFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
				<span class="n">configuration</span><span class="p">,</span>
				<span class="n">commonRpcService</span><span class="p">,</span>
				<span class="n">haServices</span><span class="p">,</span>
				<span class="n">blobServer</span><span class="p">,</span>
				<span class="n">heartbeatServices</span><span class="p">,</span>
				<span class="n">metricRegistry</span><span class="p">,</span>
				<span class="n">archivedExecutionGraphStore</span><span class="p">,</span>
				<span class="k">new</span> <span class="n">RpcMetricQueryServiceRetriever</span><span class="p">(</span><span class="n">metricRegistry</span><span class="p">.</span><span class="na">getMetricQueryServiceRpcService</span><span class="p">()),</span>
				<span class="k">this</span><span class="p">);</span>

			<span class="c1">//一旦 DispatcherResourceManagerComponent#getShutDownFuture 完成，则关闭各项服务
</span><span class="c1"></span>			<span class="n">clusterComponent</span><span class="p">.</span><span class="na">getShutDownFuture</span><span class="p">().</span><span class="na">whenComplete</span><span class="p">(</span>
				<span class="p">(</span><span class="n">ApplicationStatus</span> <span class="nf">applicationStatus</span><span class="p">,</span> <span class="n">Throwable</span> <span class="nf">throwable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">shutDownAsync</span><span class="p">(</span>
							<span class="n">ApplicationStatus</span><span class="p">.</span><span class="na">UNKNOWN</span><span class="p">,</span>
							<span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">stringifyException</span><span class="p">(</span><span class="n">throwable</span><span class="p">),</span>
							<span class="kc">false</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="c1">// This is the general shutdown path. If a separate more specific shutdown was
</span><span class="c1"></span>						<span class="c1">// already triggered, this will do nothing
</span><span class="c1"></span>						<span class="n">shutDownAsync</span><span class="p">(</span>
							<span class="n">applicationStatus</span><span class="p">,</span>
							<span class="kc">null</span><span class="p">,</span>
							<span class="kc">true</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">});</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里生成的 <code>HighAvailabilityServices</code> 和 MiniCluster 模式下略有区别，由于各组件不在同一个进程中，因而需要从配置中加载配置：1）如果采用基于 Zookeeper 的 HA 模式，则创建 <code>ZooKeeperHaServices</code>，基于 zookeeper 获取 leader 通信地址 2）如果没有配置 HA，则创建 <code>StandaloneHaServices</code>， 并从配置文件中获取各组件的 RPC 地址信息。</p>

<p>在 <code>StandaloneSessionClusterEntrypoint</code> 中，生成 <code>DispatcherResourceManagerComponent</code> 的工厂类是 <code>SessionDispatcherResourceManagerComponentFactory</code>，该工厂类创建 <code>SessionDispatcherResourceManagerComponent</code>：由 <code>SessionDispatcherFactory</code> 创建 <code>StandaloneDispatcher</code>， 由 <code>StandaloneResourceManagerFactory</code> 创建 <code>StandaloneResourceManager</code>。</p>

<p>在 <code>StandaloneJobClusterEntrypoint</code> 中，生成 <code>DispatcherResourceManagerComponent</code> 的工厂类是 <code>JobDispatcherResourceManagerComponentFactory</code>，该厂类创建 <code>JobDispatcherResourceManagerComponent</code>：由 <code>StandaloneResourceManagerFactory</code> 创建 <code>StandaloneResourceManager</code>，由 <code>JobDispatcherFactory</code> 创建 <code>MiniDispatcher</code>。一个 <code>MiniDispatcher</code> 和一个 <code>JobGraph</code> 相绑定，一旦绑定的 <code>JobGraph</code> 执行结束，则关闭 <code>MiniDispatcher</code>，进而停止 JobManager 进程。</p>

<p><code>Dispatcher</code> 和 <code>ResourceManager</code> 服务内部的启动流程则和 MiniCluster 中一致，这里不再赘述。</p>

<h3 id="taskmanager-的启动">TaskManager 的启动</h3>

<p>TaskManager 的启动入口在 <code>TaskManagerRunner</code> 中，它的启动流程和 MiniCluster 模式下基本一致，区别在于： 1)运行在独立的进程中， 2）<code>HighAvailabilityServices</code> 的创建要依赖配置文件获取。 <code>TaskManagerRunner</code> 会创建 <code>TaskExecutor</code>，<code>TaskExecutor</code> 通过 <code>HighAvailabilityServices</code> 获取 <code>ResourceManager</code> 的通信地址，并和 <code>ResourceManager</code> 建立连接。</p>

<h2 id="yarn-cluster-的启动流程">Yarn Cluster 的启动流程</h2>

<p>Yarn Cluster 的启动入口在 <code>FlinkYarnSessionCli</code> 中 ：首先根据命令行参数创建 <code>YarnClusterDescriptor</code>，接着调用 <code>YarnClusterDescriptor#deploySessionCluster</code> 触发集群的部署。</p>

<p>实际启动的逻辑在 <code>AbstractYarnClusterDescriptor#deployInternal</code> 中，主要就是通过 <code>YarnClient</code> 向 yarn 集群提交应用，启动 ApplicationMaster:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">abstract</span> <span class="nf">class</span> <span class="n">AbstractYarnClusterDescriptor</span> <span class="p">{</span>
    <span class="kd">protected</span> <span class="nf">ClusterClient</span><span class="o">&lt;</span><span class="n">ApplicationId</span><span class="o">&gt;</span> <span class="nf">deployInternal</span><span class="p">(</span>
			<span class="n">ClusterSpecification</span> <span class="nf">clusterSpecification</span><span class="p">,</span>
			<span class="n">String</span> <span class="nf">applicationName</span><span class="p">,</span>
			<span class="n">String</span> <span class="nf">yarnClusterEntrypoint</span><span class="p">,</span>
			<span class="nd">@Nullable</span> <span class="n">JobGraph</span> <span class="nf">jobGraph</span><span class="p">,</span>
			<span class="kt">boolean</span> <span class="nf">detached</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="c1">//.......
</span><span class="c1"></span>	
		<span class="n">ApplicationReport</span> <span class="nf">report</span> <span class="o">=</span> <span class="n">startAppMaster</span><span class="p">(</span>
			<span class="n">flinkConfiguration</span><span class="p">,</span>
			<span class="n">applicationName</span><span class="p">,</span>
			<span class="n">yarnClusterEntrypoint</span><span class="p">,</span>
			<span class="n">jobGraph</span><span class="p">,</span>
			<span class="n">yarnClient</span><span class="p">,</span>
			<span class="n">yarnApplication</span><span class="p">,</span>
			<span class="n">validClusterSpecification</span><span class="p">);</span>
			
		<span class="c1">//.....
</span><span class="c1"></span>
		<span class="k">return</span> <span class="n">createYarnClusterClient</span><span class="p">(</span>
			<span class="k">this</span><span class="p">,</span>
			<span class="n">validClusterSpecification</span><span class="p">.</span><span class="na">getNumberTaskManagers</span><span class="p">(),</span>
			<span class="n">validClusterSpecification</span><span class="p">.</span><span class="na">getSlotsPerTaskManager</span><span class="p">(),</span>
			<span class="n">report</span><span class="p">,</span>
			<span class="n">flinkConfiguration</span><span class="p">,</span>
			<span class="kc">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>根据 sessioncluster 和 jobcluster 者两种启动的区别， 提交到 Yarn 中 ApplicationMatser 的入口类分别为 <code>YarnSessionClusterEntrypoint</code> 和 <code>YarnJobClusterEntrypoint</code>, 区别在于 Dispatcher 分别为 <code>StandaloneDispatcher</code> 和 <code>MiniDispatcher</code>。<code>ResoureManager</code> 的具体实现类为 <code>YarnResourceManager</code>。</p>

<p>和前述的 Standalone Cluster 不同， Yarn Cluster 模式下启动的 Flink 集群，其 <code>TaskManager</code> 是由 <code>YarnResourceManager</code> 根据 JobMaster 的请求动态向 Yarn 的 ResourceManager 进行申请的。在 JobMaster 向 ResourceManager 申请资源时，如果当前没有足够的资源分配，则 <code>YarnResourceManager</code> 会向 Yarn 集群的 ResourceManager 申请新的 container，并启动 <code>TaskManager</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nf">YarnResourceManager</span> <span class="p">{</span>
	<span class="c1">//申请container
</span><span class="c1"></span>	<span class="kd">private</span> <span class="nf">void</span> <span class="n">requestYarnContainer</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">resourceManagerClient</span><span class="p">.</span><span class="na">addContainerRequest</span><span class="p">(</span><span class="n">getContainerRequest</span><span class="p">());</span>

		<span class="c1">// make sure we transmit the request fast and receive fast news of granted allocations
</span><span class="c1"></span>		<span class="n">resourceManagerClient</span><span class="p">.</span><span class="na">setHeartbeatInterval</span><span class="p">(</span><span class="n">FAST_YARN_HEARTBEAT_INTERVAL_MS</span><span class="p">);</span>

		<span class="n">numPendingContainerRequests</span><span class="o">++</span><span class="p">;</span>

		<span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Requesting new TaskExecutor container with resources {}. Number pending requests {}.&#34;</span><span class="p">,</span>
			<span class="n">resource</span><span class="p">,</span>
			<span class="n">numPendingContainerRequests</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="c1">//分配container的回调函数
</span><span class="c1"></span>	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">onContainersAllocated</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Container</span><span class="o">&gt;</span> <span class="nf">containers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runAsync</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span>
			<span class="kd">final</span> <span class="nf">Collection</span><span class="o">&lt;</span><span class="n">AMRMClient</span><span class="p">.</span><span class="na">ContainerRequest</span><span class="o">&gt;</span> <span class="nf">pendingRequests</span> <span class="o">=</span> <span class="n">getPendingRequests</span><span class="p">();</span>
			<span class="kd">final</span> <span class="nf">Iterator</span><span class="o">&lt;</span><span class="n">AMRMClient</span><span class="p">.</span><span class="na">ContainerRequest</span><span class="o">&gt;</span> <span class="nf">pendingRequestsIterator</span> <span class="o">=</span> <span class="n">pendingRequests</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">Container</span> <span class="nf">container</span> <span class="o">:</span> <span class="n">containers</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span>
					<span class="s">&#34;Received new container: {} - Remaining pending container requests: {}&#34;</span><span class="p">,</span>
					<span class="n">container</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span>
					<span class="n">numPendingContainerRequests</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">numPendingContainerRequests</span> <span class="o">&gt;</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">removeContainerRequest</span><span class="p">(</span><span class="n">pendingRequestsIterator</span><span class="p">.</span><span class="na">next</span><span class="p">());</span>

					<span class="kd">final</span> <span class="nf">String</span> <span class="n">containerIdStr</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
					<span class="kd">final</span> <span class="nf">ResourceID</span> <span class="n">resourceId</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceID</span><span class="p">(</span><span class="n">containerIdStr</span><span class="p">);</span>

					<span class="n">workerNodeMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">resourceId</span><span class="p">,</span> <span class="k">new</span> <span class="n">YarnWorkerNode</span><span class="p">(</span><span class="n">container</span><span class="p">));</span>

					<span class="k">try</span> <span class="p">{</span>
						<span class="c1">// Context information used to start a TaskExecutor Java process
</span><span class="c1"></span>						<span class="n">ContainerLaunchContext</span> <span class="nf">taskExecutorLaunchContext</span> <span class="o">=</span> <span class="n">createTaskExecutorLaunchContext</span><span class="p">(</span>
							<span class="n">container</span><span class="p">.</span><span class="na">getResource</span><span class="p">(),</span>
							<span class="n">containerIdStr</span><span class="p">,</span>
							<span class="n">container</span><span class="p">.</span><span class="na">getNodeId</span><span class="p">().</span><span class="na">getHost</span><span class="p">());</span>
                        <span class="c1">//启动 TaskManager
</span><span class="c1"></span>						<span class="n">nodeManagerClient</span><span class="p">.</span><span class="na">startContainer</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">taskExecutorLaunchContext</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="nf">t</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;Could not start TaskManager in container {}.&#34;</span><span class="p">,</span> <span class="n">container</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">t</span><span class="p">);</span>

						<span class="c1">// release the failed container
</span><span class="c1"></span>						<span class="n">workerNodeMap</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">resourceId</span><span class="p">);</span>
						<span class="n">resourceManagerClient</span><span class="p">.</span><span class="na">releaseAssignedContainer</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
						<span class="c1">// and ask for a new one
</span><span class="c1"></span>						<span class="n">requestYarnContainerIfRequired</span><span class="p">();</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="c1">// return the excessive containers
</span><span class="c1"></span>					<span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Returning excess container {}.&#34;</span><span class="p">,</span> <span class="n">container</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
					<span class="n">resourceManagerClient</span><span class="p">.</span><span class="na">releaseAssignedContainer</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="c1">// if we are waiting for no further containers, we can go to the
</span><span class="c1"></span>			<span class="c1">// regular heartbeat interval
</span><span class="c1"></span>			<span class="k">if</span> <span class="p">(</span><span class="n">numPendingContainerRequests</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">resourceManagerClient</span><span class="p">.</span><span class="na">setHeartbeatInterval</span><span class="p">(</span><span class="n">yarnHeartbeatIntervalMillis</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">});</span>
	<span class="p">}</span>
	
	<span class="c1">//创建 TaskManager 的启动上下文
</span><span class="c1"></span>	<span class="kd">private</span> <span class="nf">ContainerLaunchContext</span> <span class="n">createTaskExecutorLaunchContext</span><span class="p">(</span><span class="n">Resource</span> <span class="nf">resource</span><span class="p">,</span> <span class="n">String</span> <span class="nf">containerId</span><span class="p">,</span> <span class="n">String</span> <span class="nf">host</span><span class="p">)</span>
			<span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
		<span class="c1">// init the ContainerLaunchContext
</span><span class="c1"></span>		<span class="kd">final</span> <span class="nf">String</span> <span class="n">currDir</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ApplicationConstants</span><span class="p">.</span><span class="na">Environment</span><span class="p">.</span><span class="na">PWD</span><span class="p">.</span><span class="na">key</span><span class="p">());</span>

		<span class="kd">final</span> <span class="nf">ContaineredTaskManagerParameters</span> <span class="n">taskManagerParameters</span> <span class="o">=</span>
				<span class="n">ContaineredTaskManagerParameters</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">flinkConfig</span><span class="p">,</span> <span class="n">resource</span><span class="p">.</span><span class="na">getMemory</span><span class="p">(),</span> <span class="n">numberOfTaskSlots</span><span class="p">);</span>

		<span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;TaskExecutor {} will be started with container size {} MB, JVM heap size {} MB, &#34;</span> <span class="o">+</span>
				<span class="s">&#34;JVM direct memory limit {} MB&#34;</span><span class="p">,</span>
				<span class="n">containerId</span><span class="p">,</span>
				<span class="n">taskManagerParameters</span><span class="p">.</span><span class="na">taskManagerTotalMemoryMB</span><span class="p">(),</span>
				<span class="n">taskManagerParameters</span><span class="p">.</span><span class="na">taskManagerHeapSizeMB</span><span class="p">(),</span>
				<span class="n">taskManagerParameters</span><span class="p">.</span><span class="na">taskManagerDirectMemoryLimitMB</span><span class="p">());</span>

		<span class="n">Configuration</span> <span class="nf">taskManagerConfig</span> <span class="o">=</span> <span class="n">BootstrapTools</span><span class="p">.</span><span class="na">cloneConfiguration</span><span class="p">(</span><span class="n">flinkConfig</span><span class="p">);</span>

		<span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;TaskManager configuration: {}&#34;</span><span class="p">,</span> <span class="n">taskManagerConfig</span><span class="p">);</span>

		<span class="n">ContainerLaunchContext</span> <span class="nf">taskExecutorLaunchContext</span> <span class="o">=</span> <span class="n">Utils</span><span class="p">.</span><span class="na">createTaskExecutorContext</span><span class="p">(</span>
			<span class="n">flinkConfig</span><span class="p">,</span>
			<span class="n">yarnConfig</span><span class="p">,</span>
			<span class="n">env</span><span class="p">,</span>
			<span class="n">taskManagerParameters</span><span class="p">,</span>
			<span class="n">taskManagerConfig</span><span class="p">,</span>
			<span class="n">currDir</span><span class="p">,</span>
			<span class="n">YarnTaskExecutorRunner</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="c1">//入口类
</span><span class="c1"></span>			<span class="n">log</span><span class="p">);</span>

		<span class="c1">// set a special environment variable to uniquely identify this container
</span><span class="c1"></span>		<span class="n">taskExecutorLaunchContext</span><span class="p">.</span><span class="na">getEnvironment</span><span class="p">()</span>
				<span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ENV_FLINK_CONTAINER_ID</span><span class="p">,</span> <span class="n">containerId</span><span class="p">);</span>
		<span class="n">taskExecutorLaunchContext</span><span class="p">.</span><span class="na">getEnvironment</span><span class="p">()</span>
				<span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ENV_FLINK_NODE_ID</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">taskExecutorLaunchContext</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="小结">小结</h2>

<p>本文简单分析了 Flink 集群的启动流程，以及 <code>ResourceManager</code>、 <code>TaskExecutor</code>
<code>Dispatcher</code>、 <code>JobMaster</code> 等不同组件之间的通信过程。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=65147077">FLIP-6 - Flink Deployment and Process Model - Standalone, Yarn, Mesos, Kubernetes, etc.</a></li>
</ul>

<p>-EOF-</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"><a rel="license noopener" href="https://blog.jrwang.me" target="_blank">jrthe42</a></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">原始链接</span>
    <span class="item-content"><a href="https://blog.jrwang.me/2019/flink-source-code-bootstarp/">https://blog.jrwang.me/2019/flink-source-code-bootstarp/</a></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-05-05
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/flink/">Flink</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2019/flink-source-code-resource-manager/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Flink 源码阅读笔记（6）- 计算资源管理</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/2019/flink-source-code-rpc/">
            <span class="next-text nav-default">Flink 源码阅读笔记（4）- RPC</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="jrthe42/blog-comment"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:jrthe42@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/jrthe42" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/jrthe42" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://blog.jrwang.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2015 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author"><a rel="license noopener" href="https://blog.jrwang.me" target="_blank">jrthe42</a></span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.f79f403f.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-66913886-2', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
