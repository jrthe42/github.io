<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Flink 源码阅读笔记（21）- Flink JobManager HA 机制的扩展与实现 - JR&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="jrthe42" /><meta name="description" content="在 Flink 1.12 中，Flink on Kubernetes 的 Native 部署方案由实验特性正式变更为生产环境可用。其中一个重要特性是扩展了 HA 的实现，引入了一种新的、完全基于 Kubernetes 的 HA 方案。" /><meta name="keywords" content="jrthe42, Blog, Programming" />






<meta name="generator" content="Hugo 0.59.0 with theme even" />


<link rel="canonical" href="https://blog.jrwang.me/2020/2020-12-26-flink-ha/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.7d171193.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Flink 源码阅读笔记（21）- Flink JobManager HA 机制的扩展与实现" />
<meta property="og:description" content="在 Flink 1.12 中，Flink on Kubernetes 的 Native 部署方案由实验特性正式变更为生产环境可用。其中一个重要特性是扩展了 HA 的实现，引入了一种新的、完全基于 Kubernetes 的 HA 方案。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.jrwang.me/2020/2020-12-26-flink-ha/" />
<meta property="article:published_time" content="2020-12-26T20:00:00+08:00" />
<meta property="article:modified_time" content="2021-03-23T22:15:27+08:00" />
<meta itemprop="name" content="Flink 源码阅读笔记（21）- Flink JobManager HA 机制的扩展与实现">
<meta itemprop="description" content="在 Flink 1.12 中，Flink on Kubernetes 的 Native 部署方案由实验特性正式变更为生产环境可用。其中一个重要特性是扩展了 HA 的实现，引入了一种新的、完全基于 Kubernetes 的 HA 方案。">


<meta itemprop="datePublished" content="2020-12-26T20:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2021-03-23T22:15:27&#43;08:00" />
<meta itemprop="wordCount" content="4758">



<meta itemprop="keywords" content="Flink,实时计算,高可用,Kubernetes," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Flink 源码阅读笔记（21）- Flink JobManager HA 机制的扩展与实现"/>
<meta name="twitter:description" content="在 Flink 1.12 中，Flink on Kubernetes 的 Native 部署方案由实验特性正式变更为生产环境可用。其中一个重要特性是扩展了 HA 的实现，引入了一种新的、完全基于 Kubernetes 的 HA 方案。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">JRTHE42</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">JRTHE42</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Flink 源码阅读笔记（21）- Flink JobManager HA 机制的扩展与实现</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-12-26 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#jobmanager-ha-机制">JobManager HA 机制</a></li>
<li><a href="#服务抽象">服务抽象</a>
<ul>
<li><a href="#选举服务">选举服务</a></li>
<li><a href="#服务发现">服务发现</a></li>
<li><a href="#状态保存">状态保存</a></li>
</ul></li>
<li><a href="#基于-zookeeper-的-ha-实现">基于 ZooKeeper 的 HA 实现</a>
<ul>
<li><a href="#leader-选举">Leader 选举</a></li>
<li><a href="#服务发现-1">服务发现</a></li>
<li><a href="#状态保存-1">状态保存</a></li>
<li><a href="#checkpointidcount">CheckpointIDCount</a></li>
</ul></li>
<li><a href="#基于-kubernetes-的-ha-实现">基于 Kubernetes 的 HA 实现</a>
<ul>
<li><a href="#leader-选举-1">Leader 选举</a></li>
<li><a href="#服务发现-2">服务发现</a></li>
<li><a href="#状态保存-2">状态保存</a></li>
<li><a href="#checkpointidcount-1">CheckpointIDCount</a></li>
</ul></li>
<li><a href="#小结">小结</a></li>
<li><a href="#参考">参考</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<p>在 Flink 1.12 中，Flink on Kubernetes 的 Native 部署方案由实验特性正式变更为生产环境可用。其中一个重要特性是扩展了 HA 的实现，引入了一种新的、完全基于 Kubernetes 的 HA 方案。在此之前，Flink on Kubernetes 部署时如果需要开启 HA，需要依赖 ZooKeeper 来实现。在有了基于 Kubernetes 的 HA 方案后，不需要单独维护 ZooKeeper 集群，这样显然方便了不少。</p>

<h2 id="jobmanager-ha-机制">JobManager HA 机制</h2>

<p>HA，即高可用，主要是为了解决分布式系统中组件的单点失败（single point of failure）的问题。在一个 Flink 集群中，JobManager 负责协调各个组件，承担了任务调度和资源管理的主要的作用。默认情况下，一个 Flink 集群中只有一个 JobManager，一旦 JobManager 因为某种原因宕掉，那么集群中所有运行的任务都将失败。如果开启了 HA，那么将会有一个新的 JobManager 接管之前的 JobManager 的工作，从而避免任务失败的情况。</p>

<p>为了实现 JobManager 的 HA，需要几个服务的配合，即：</p>

<ul>
<li>选举服务：从多个候选者中选出一个 Leader<br /></li>
<li>服务发现：获取当前 Leader 的地址<br /></li>
<li>状态保存：恢复作业运行时需要的一些状态（JobGraphs, user code jars, completed checkpoints），这个一般需要借助共享存储（如 HDFS，S3）完成<br /></li>
</ul>

<h2 id="服务抽象">服务抽象</h2>

<p><img src="/img/flink-ha/flink-ha-HighAvailabilityServices.png" alt="Flink-HighAvailabilityServices" /></p>

<p>在 Flink 中，HA 依赖的服务被封装在 <code>HighAvailabilityServices</code> 中，这里面涉及到的一些关键组件包括：</p>

<ul>
<li>LeaderElectionService<br />

<ul>
<li>有四个组件需要用到选举服务：<code>Dispatcher</code>，<code>ResourceManager</code>，<code>JobManager</code>(每个作业有一个)，<code>RestEndpoint</code><br /></li>
</ul></li>
<li>LeaderRetrievalService<br />

<ul>
<li>获取各个服务的地址，例如 Client 提交作业时需要获取 <code>RestEndpoint</code>，<code>TaskManager</code> 获取 <code>ResourceManager</code> 地址用于注册、提供计算资源等<br /></li>
</ul></li>
<li>RunningJobsRegistry<br />

<ul>
<li>作业运行状态的注册表<br /></li>
</ul></li>
<li>JobGraphStore<br />

<ul>
<li>存储 JobGraph<br /></li>
</ul></li>
<li>BlobStore<br />

<ul>
<li>存储作业运行期间的一些二进制文件<br /></li>
</ul></li>
<li>CheckpointRecoveryFactory<br />

<ul>
<li><code>CompletedCheckpointStore</code>，存储已经完成的 Checkpoint 的元数据信息</li>
<li><code>CheckpointIDCounter</code>，生成 checkpoint id<br /></li>
</ul></li>
</ul>

<h3 id="选举服务">选举服务</h3>

<p><img src="/img/flink-ha/flink-ha-LeaderElectionService.png" alt="Flink-LeaderElectionService" /></p>

<p>Leader 选举主要依赖 <code>LeaderElectionService</code>（选举服务）和 <code>LeaderContender</code>（参与竞选的对象）共同来完成。</p>

<p><code>LeaderContender</code> 是具体的需要进行选举的组件，例如 <code>ResourceManager</code>, <code>DispatcherRunner</code>，<code>JobManagerRunner</code> 等。当一个 LeaderContender 竞选成功后，会通过 <code>LeaderContender#grantLeadership(UUID leaderSessionId)</code> 得到通知。</p>

<p>每一个 <code>LeaderContender</code> 都会有一个关联的 <code>LeaderElectionService</code> 对象。在成功竞选为 Leader 后，<code>LeaderElectionService</code> 会生成一个 <code>leaderSessionId</code>，这个 id 作为此次选举成功的唯一标识告知 <code>LeaderContender</code>，一旦 <code>LeaderContender</code> 确认自己的 leader 角色后，会调用 <code>LeaderElectionService#confirmLeadership(UUID leaderSessionID, String leaderAddress)</code> 来发布自己的地址。</p>

<p>对于选举服务的具体实现，一般是借助一种分布式协调系统，比如 ZooKeeper，Etcd 等来完成，或者也可以自己实现分布式一致性算法。在 Flink 中，把选举服务的具体实现留在 <code>LeaderElectionDriver</code> 接口中，有基于 ZooKeeper 的实现 <code>ZooKeeperLeaderElectionDriver</code>，也有基于 Kubernetes ConfigMap (底层基于 Etcd) 的实现 <code>KubernetesLeaderElectionDriver</code>。</p>

<h3 id="服务发现">服务发现</h3>

<p><img src="/img/flink-ha/flink-ha-LeaderRetrievalService.png" alt="Flink-LeaderRetrievalService" /></p>

<p>服务发现的主要目的是获取各个服务组件的 Leader 地址，其实现主要是依赖 <code>LeaderRetrievalService</code> 和 <code>LeaderRetrievalListner</code> 这两个接口。<code>LeaderRetriverService</code> 可以启动一个对 Leader 地址的监听，并通知 <code>LeaderRetrievalListner</code>。</p>

<p>在 HA 模式下，<code>LeaderRetrievalService</code> 的具体实现是 <code>DefaultLeaderRetrievalService</code>。服务发现和选举是伴生的，前面说过，选举完成后会发布 Leader 地址，所谓发布，就是要把地址信息放在一个共享存储中，例如 ZokKeeper 的节点，或者 Kubernetes ConfigMap 中，对应的地址获取逻辑见 <code>ZooKeeperLeaderRetrievalDriver</code> 和 <code>KubernetesLeaderRetrievalDriver</code>。</p>

<h3 id="状态保存">状态保存</h3>

<p>状态保存的目的是在 Leader 发生切换后，新的 Leader 能够获取到旧的 Leader 保存的状态数据。这里保存的数据分为两类，一种是比较轻量级的数据，例如在 <code>RunningJobsRegistry</code> 中存储的任务运行状态，另一种存储的数据量可能比较大，例如 JobGraph，用户提供的 Jar 文件，<code>CompletedCheckpointStore</code> 中存储的 CompletedCheckpoint。对于第一类数据，直接借助 ZooKeeper 或者 Kubernetes 的存储能力即可满足要求；而对于后一种数据，则一般采取将数据存在共享文件系统，然后将文件系统路径存储在 ZooKeeper 或者 Kubernetes ConfigMap 中。</p>

<p><img src="/img/flink-ha/flink-ha-StateHandleStore.png" alt="Flink-StateHandleStore" /></p>

<p>状态存储的主要逻辑参考 <code>StateHandleStore</code> 和 <code>RetrievableStateStorageHelper</code>。</p>

<h2 id="基于-zookeeper-的-ha-实现">基于 ZooKeeper 的 HA 实现</h2>

<p>基于 ZooKeeper 的选举和服务发现是分布式系统中比较常见的技术选型了。所有参加选举的候选者都尝试去 ZooKeeper 中创建一个临时节点，最先创建成功的成为 Leader。临时节点在会话断开后被自动删除，其它 follower 可监听该临时节点，在节点删除后获得通知，重新参与竞选。</p>

<p>我们一般不会直接使用原生的 API 操作 ZooKeeper。Netflex 开源的 Apache Curator 框架封装了对连接管理、会话失效等一些异常问题的处理
，而且提供了一些常见的诸如选举、分布式锁等常用算法的实现，是目前使用 ZooKeeper 的主流方式。Flink 中对 ZooKeeper 的操作也是借助 Curator 完成的。</p>

<h3 id="leader-选举">Leader 选举</h3>

<p>Flink 使用 ZK 进行 Leader 选举的主要逻辑在 <code>ZooKeeperLeaderElectionDriver</code> 中，不同组件的实现是一样的，只是用来进行选举的 ZK 路径不一样。</p>

<p>Curator 中 <code>LeaderLatch</code> 封装了 Leader 选举的基本逻辑，<code>LeaderLatch</code> 接受一个回调对象 <code>LeaderLatchListener</code>，在选举成功后会得到回调通知。
<code>ZooKeeperLeaderElectionDriver</code> 同样通过 <code>NodeCache</code> 实现了对 Leader 地址节点的监听，在节点信息发生变化时会得到回调，这个主要是为了让 Leader 节点修正 ZK 中保存的 Leader 信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">ZooKeeperLeaderElectionDriver</span>
        <span class="nf">implements</span> <span class="n">LeaderElectionDriver</span><span class="p">,</span>
                <span class="n">LeaderLatchListener</span><span class="p">,</span>
                <span class="n">NodeCacheListener</span><span class="p">,</span>
                <span class="n">UnhandledErrorListener</span> <span class="p">{</span>
    
    <span class="cm">/** Curator recipe for leader election. */</span>
    <span class="kd">private</span> <span class="nf">final</span> <span class="n">LeaderLatch</span> <span class="nf">leaderLatch</span><span class="p">;</span>

    <span class="cm">/** Curator recipe to watch a given ZooKeeper node for changes. */</span>
    <span class="kd">private</span> <span class="nf">final</span> <span class="n">NodeCache</span> <span class="nf">cache</span><span class="p">;</span>

    <span class="cm">/** ZooKeeper path of the node which stores the current leader information. */</span>
    <span class="kd">private</span> <span class="nf">final</span> <span class="n">String</span> <span class="nf">leaderPath</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">ZooKeeperLeaderElectionDriver</span><span class="p">(</span>
        <span class="n">CuratorFramework</span> <span class="nf">client</span><span class="p">,</span>
        <span class="n">String</span> <span class="nf">latchPath</span><span class="p">,</span>
        <span class="n">String</span> <span class="nf">leaderPath</span><span class="p">,</span>
        <span class="n">LeaderElectionEventHandler</span> <span class="nf">leaderElectionEventHandler</span><span class="p">,</span>
        <span class="n">FatalErrorHandler</span> <span class="nf">fatalErrorHandler</span><span class="p">,</span>
        <span class="n">String</span> <span class="nf">leaderContenderDescription</span><span class="p">)</span>
        <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
        <span class="n">leaderLatch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LeaderLatch</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">checkNotNull</span><span class="p">(</span><span class="n">latchPath</span><span class="p">));</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NodeCache</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">leaderPath</span><span class="p">);</span>

        <span class="n">client</span><span class="p">.</span><span class="na">getUnhandledErrorListenable</span><span class="p">().</span><span class="na">addListener</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

        <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="c1">// 选举
</span><span class="c1"></span>        <span class="n">leaderLatch</span><span class="p">.</span><span class="na">addListener</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">leaderLatch</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>

        <span class="c1">// 监听节点变化
</span><span class="c1"></span>        <span class="n">cache</span><span class="p">.</span><span class="na">getListenable</span><span class="p">().</span><span class="na">addListener</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">cache</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>

        <span class="n">client</span><span class="p">.</span><span class="na">getConnectionStateListenable</span><span class="p">().</span><span class="na">addListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在选举完成后，会将 Leader 信息写入 ZK 的节点中，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">ZooKeeperLeaderElectionDriver</span> <span class="p">{</span>
    <span class="cm">/** Writes the current leader&#39;s address as well the given leader session ID to ZooKeeper. */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">writeLeaderInformation</span><span class="p">(</span><span class="n">LeaderInformation</span> <span class="nf">leaderInformation</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//...
</span><span class="c1"></span>        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// ...
</span><span class="c1"></span>            <span class="kt">boolean</span> <span class="nf">dataWritten</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">dataWritten</span> <span class="o">&amp;&amp;</span> <span class="n">leaderLatch</span><span class="p">.</span><span class="na">hasLeadership</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">Stat</span> <span class="nf">stat</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">checkExists</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="n">leaderPath</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">long</span> <span class="nf">owner</span> <span class="o">=</span> <span class="n">stat</span><span class="p">.</span><span class="na">getEphemeralOwner</span><span class="p">();</span>
                    <span class="kt">long</span> <span class="nf">sessionID</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">getZookeeperClient</span><span class="p">().</span><span class="na">getZooKeeper</span><span class="p">().</span><span class="na">getSessionId</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">owner</span> <span class="o">==</span> <span class="n">sessionID</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">try</span> <span class="p">{</span>
                            <span class="n">client</span><span class="p">.</span><span class="na">setData</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="n">leaderPath</span><span class="p">,</span> <span class="n">baos</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">());</span>
                            <span class="n">dataWritten</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">KeeperException</span><span class="p">.</span><span class="na">NoNodeException</span> <span class="nf">noNode</span><span class="p">)</span> <span class="p">{</span>
                            <span class="c1">// node was deleted in the meantime
</span><span class="c1"></span>                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">try</span> <span class="p">{</span>
                            <span class="n">client</span><span class="p">.</span><span class="na">delete</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="n">leaderPath</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">KeeperException</span><span class="p">.</span><span class="na">NoNodeException</span> <span class="nf">noNode</span><span class="p">)</span> <span class="p">{</span>
                            <span class="c1">// node was deleted in the meantime --&gt; try again
</span><span class="c1"></span>                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="n">client</span><span class="p">.</span><span class="na">create</span><span class="p">().</span><span class="na">creatingParentsIfNeeded</span><span class="p">()</span>
                            <span class="p">.</span><span class="na">withMode</span><span class="p">(</span><span class="n">CreateMode</span><span class="p">.</span><span class="na">EPHEMERAL</span><span class="p">)</span>
                            <span class="p">.</span><span class="na">forPath</span><span class="p">(</span><span class="n">leaderPath</span><span class="p">,</span> <span class="n">baos</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">());</span>
                        <span class="n">dataWritten</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">KeeperException</span><span class="p">.</span><span class="na">NodeExistsException</span> <span class="nf">nodeExists</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// node has been created in the meantime --&gt; try again
</span><span class="c1"></span>                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="服务发现-1">服务发现</h3>

<p>获取 Leader 地址的逻辑比较简单，就是监听 ZooKeeper 节点的数据变化，从节点中取出 Leader 选举完成后写入的信息。主要的逻辑就是借助 <code>NodeCache</code> 来完成的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nf">ZooKeeperLeaderRetrievalDriver</span>
        <span class="kd">implements</span> <span class="nf">LeaderRetrievalDriver</span><span class="p">,</span> <span class="n">NodeCacheListener</span><span class="p">,</span> <span class="n">UnhandledErrorListener</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">ZooKeeperLeaderRetrievalDriver</span><span class="p">(</span>
            <span class="n">CuratorFramework</span> <span class="nf">client</span><span class="p">,</span>
            <span class="n">String</span> <span class="nf">retrievalPath</span><span class="p">,</span>
            <span class="n">LeaderRetrievalEventHandler</span> <span class="nf">leaderRetrievalEventHandler</span><span class="p">,</span>
            <span class="n">FatalErrorHandler</span> <span class="nf">fatalErrorHandler</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NodeCache</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">retrievalPath</span><span class="p">);</span>

        <span class="n">client</span><span class="p">.</span><span class="na">getUnhandledErrorListenable</span><span class="p">().</span><span class="na">addListener</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">cache</span><span class="p">.</span><span class="na">getListenable</span><span class="p">().</span><span class="na">addListener</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">cache</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>

        <span class="n">client</span><span class="p">.</span><span class="na">getConnectionStateListenable</span><span class="p">().</span><span class="na">addListener</span><span class="p">(</span><span class="n">connectionStateListener</span><span class="p">);</span>

        <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">nodeChanged</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">retrieveLeaderInformationFromZooKeeper</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="nf">void</span> <span class="n">retrieveLeaderInformationFromZooKeeper</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">final</span> <span class="nf">ChildData</span> <span class="n">childData</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="na">getCurrentData</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">childData</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">final</span> <span class="nf">byte</span><span class="p">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">childData</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ByteArrayInputStream</span> <span class="nf">bais</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
                    <span class="n">ObjectInputStream</span> <span class="nf">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">bais</span><span class="p">);</span>

                    <span class="kd">final</span> <span class="nf">String</span> <span class="n">leaderAddress</span> <span class="o">=</span> <span class="n">ois</span><span class="p">.</span><span class="na">readUTF</span><span class="p">();</span>
                    <span class="kd">final</span> <span class="nf">UUID</span> <span class="n">leaderSessionID</span> <span class="o">=</span> <span class="p">(</span><span class="n">UUID</span><span class="p">)</span> <span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span>
                    <span class="n">leaderRetrievalEventHandler</span><span class="p">.</span><span class="na">notifyLeaderAddress</span><span class="p">(</span>
                            <span class="n">LeaderInformation</span><span class="p">.</span><span class="na">known</span><span class="p">(</span><span class="n">leaderSessionID</span><span class="p">,</span> <span class="n">leaderAddress</span><span class="p">));</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">leaderRetrievalEventHandler</span><span class="p">.</span><span class="na">notifyLeaderAddress</span><span class="p">(</span><span class="n">LeaderInformation</span><span class="p">.</span><span class="na">empty</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="状态保存-1">状态保存</h3>

<p>对于比较轻量的状态，如作业运行状态，直接基于固定的 ZK 路径进行读写即可：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">KubernetesRunningJobsRegistry</span> <span class="nf">implements</span> <span class="n">RunningJobsRegistry</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">setJobRunning</span><span class="p">(</span><span class="n">JobID</span> <span class="nf">jobID</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
        <span class="n">writeJobStatusToConfigMap</span><span class="p">(</span><span class="n">jobID</span><span class="p">,</span> <span class="n">JobSchedulingStatus</span><span class="p">.</span><span class="na">RUNNING</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="nf">void</span> <span class="n">writeJobStatusToConfigMap</span><span class="p">(</span><span class="n">JobID</span> <span class="nf">jobID</span><span class="p">,</span> <span class="n">JobSchedulingStatus</span> <span class="nf">status</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="nf">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">getKeyForJobId</span><span class="p">(</span><span class="n">jobID</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">kubeClient</span><span class="p">.</span><span class="na">checkAndUpdateConfigMap</span><span class="p">(</span>
                            <span class="n">configMapName</span><span class="p">,</span>
                            <span class="n">configMap</span> <span class="o">-&gt;</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">KubernetesLeaderElector</span><span class="p">.</span><span class="na">hasLeadership</span><span class="p">(</span><span class="n">configMap</span><span class="p">,</span> <span class="n">lockIdentity</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="kd">final</span> <span class="nf">Optional</span><span class="o">&lt;</span><span class="n">JobSchedulingStatus</span><span class="o">&gt;</span> <span class="nf">optional</span> <span class="o">=</span> <span class="n">getJobStatus</span><span class="p">(</span><span class="n">configMap</span><span class="p">,</span> <span class="n">jobID</span><span class="p">);</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">optional</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span> <span class="o">||</span> <span class="n">optional</span><span class="p">.</span><span class="na">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">configMap</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">status</span><span class="p">.</span><span class="na">name</span><span class="p">());</span>
                                        <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">configMap</span><span class="p">);</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                                <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
                            <span class="p">})</span>
                    <span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>对于数据量比较大的状态，如 JobGraph，CompletedCheckpoint，则先写入共享文件系统，然后将文件路径保存的 ZK 中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">ZooKeeperStateHandleStore</span><span class="o">&lt;</span><span class="n">T</span> <span class="nf">extends</span> <span class="n">Serializable</span><span class="o">&gt;</span>
        <span class="nf">implements</span> <span class="n">StateHandleStore</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">IntegerResourceVersion</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">RetrievableStateHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">addAndLock</span><span class="p">(</span><span class="n">String</span> <span class="nf">pathInZooKeeper</span><span class="p">,</span> <span class="n">T</span> <span class="nf">state</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>

        <span class="kd">final</span> <span class="nf">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">normalizePath</span><span class="p">(</span><span class="n">pathInZooKeeper</span><span class="p">);</span>

        <span class="c1">// 写入外部存储
</span><span class="c1"></span>        <span class="n">RetrievableStateHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">storeHandle</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="na">store</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

        <span class="c1">// 将路径等元信息写入 ZK
</span><span class="c1"></span>        <span class="kt">boolean</span> <span class="nf">success</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// Serialize the state handle. This writes the state to the backend.
</span><span class="c1"></span>            <span class="kt">byte</span><span class="p">[]</span> <span class="nf">serializedStoreHandle</span> <span class="o">=</span> <span class="n">InstantiationUtil</span><span class="p">.</span><span class="na">serializeObject</span><span class="p">(</span><span class="n">storeHandle</span><span class="p">);</span>

            <span class="c1">// Write state handle (not the actual state) to ZooKeeper. This is expected to be
</span><span class="c1"></span>            <span class="c1">// smaller than the state itself. This level of indirection makes sure that data in
</span><span class="c1"></span>            <span class="c1">// ZooKeeper is small, because ZooKeeper is designed for data in the KB range, but
</span><span class="c1"></span>            <span class="c1">// the state can be larger.
</span><span class="c1"></span>            <span class="c1">// Create the lock node in a transaction with the actual state node. That way we can
</span><span class="c1"></span>            <span class="c1">// prevent
</span><span class="c1"></span>            <span class="c1">// race conditions with a concurrent delete operation.
</span><span class="c1"></span>            <span class="n">client</span><span class="p">.</span><span class="na">inTransaction</span><span class="p">()</span>
                    <span class="p">.</span><span class="na">create</span><span class="p">()</span>
                    <span class="p">.</span><span class="na">withMode</span><span class="p">(</span><span class="n">CreateMode</span><span class="p">.</span><span class="na">PERSISTENT</span><span class="p">)</span>
                    <span class="p">.</span><span class="na">forPath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">serializedStoreHandle</span><span class="p">)</span>
                    <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                    <span class="p">.</span><span class="na">create</span><span class="p">()</span>
                    <span class="p">.</span><span class="na">withMode</span><span class="p">(</span><span class="n">CreateMode</span><span class="p">.</span><span class="na">EPHEMERAL</span><span class="p">)</span>
                    <span class="p">.</span><span class="na">forPath</span><span class="p">(</span><span class="n">getLockPath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                    <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                    <span class="p">.</span><span class="na">commit</span><span class="p">();</span>

            <span class="n">success</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">storeHandle</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">KeeperException</span><span class="p">.</span><span class="na">NodeExistsException</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// We wrap the exception here so that it could be caught in DefaultJobGraphStore
</span><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">AlreadyExistException</span><span class="p">(</span><span class="s">&#34;ZooKeeper node &#34;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&#34; already exists.&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Cleanup the state handle if it was not written to ZooKeeper.
</span><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">storeHandle</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">storeHandle</span><span class="p">.</span><span class="na">discardState</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="checkpointidcount">CheckpointIDCount</h3>

<p>在 Flink 触发 Checkpoint 的时候需要一个递增的 ID 生成器，这个在 ZK 中主要是借助 Curator 提供的分布式计数器 <code>SharedCount</code> 实现的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">ZooKeeperCheckpointIDCounter</span> <span class="nf">implements</span> <span class="n">CheckpointIDCounter</span> <span class="p">{</span>
    <span class="cm">/** Curator recipe for shared counts. */</span>
    <span class="kd">private</span> <span class="nf">final</span> <span class="n">SharedCount</span> <span class="nf">sharedCount</span><span class="p">;</span>

        <span class="kd">public</span> <span class="nf">ZooKeeperCheckpointIDCounter</span><span class="p">(</span>
            <span class="n">CuratorFramework</span> <span class="nf">client</span><span class="p">,</span>
            <span class="n">String</span> <span class="nf">counterPath</span><span class="p">,</span>
            <span class="n">LastStateConnectionStateListener</span> <span class="nf">connectionStateListener</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">sharedCount</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SharedCount</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">counterPath</span><span class="p">,</span> <span class="n">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="基于-kubernetes-的-ha-实现">基于 Kubernetes 的 HA 实现</h2>

<p>Kubernetes 官方在<a href="https://kubernetes.io/blog/2016/01/simple-leader-election-with-kubernetes/">Simple leader election with Kubernetes and Docker</a>这篇文章中描述了如何基于 Kubernetes 来实现一个 Leader 选举服务。主要依赖 Kubernetes 的两个特性：</p>

<ul>
<li>ResourceVersions: 每一个 API Object 都有一个唯一的资源版本，可以基于这个特性实现 CAS 操作</li>
<li>Annotations: 每一个 API Object 可以被标注上一组 key/value 属性，用来保存一些元数据</li>
</ul>

<p>Kubernetes 官方的 Java API 提供了 Leader 选举服务的<a href="https://github.com/kubernetes-client/java/tree/master/extended/src/main/java/io/kubernetes/client/extended/leaderelection">具体实现</a>，Flink 使用的 Fabric8io kubernetes-client 也有相应的<a href="https://github.com/fabric8io/kubernetes-client/tree/master/kubernetes-client/src/main/java/io/fabric8/kubernetes/client/extended/leaderelection">实现</a>。</p>

<p>在 Kubernetes 中，ConfigMap 可以当作轻量的键值存储使用，因此可以用来保存一些元数据信息，类似于 ZooKeeper 中用 ZNode 节点来保存元数据。</p>

<p>Flink 内部还基于 ResourceVersions 封装了一个对 ConfigMap 的 CAS 操作，以保证原子性，具体的逻辑见 <code>FlinkKubeClient#checkAndUpdateConfigMap(String configMapName, Function&lt;KubernetesConfigMap, Optional&lt;KubernetesConfigMap&gt;&gt; function)</code>。</p>

<h3 id="leader-选举-1">Leader 选举</h3>

<p>Flink 基于 Kubernetes 实现选举服务的主要逻辑在 <code>KubernetesLeaderElectionDriver</code> 中。由于 Kubernetes-client 的 <code>LeaderElector#run()</code> 是一个阻塞操作，Flink 提供了一个 <code>KubernetesLeaderElector</code> 将封装在 Executor 中变为一个非阻塞操作。<code>LeaderElector</code> 会尝试创建相应的 leader ConfigMap，每一个 <code>KubernetesLeaderElectionDriver</code> 会生成一个唯一的标识，这个标识在选举时会写入 config map 的 annotation 中，后面用来识别当前对象是否 leader。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">KubernetesLeaderElector</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">KubernetesLeaderElector</span><span class="p">(</span>
            <span class="n">NamespacedKubernetesClient</span> <span class="nf">kubernetesClient</span><span class="p">,</span>
            <span class="n">KubernetesLeaderElectionConfiguration</span> <span class="nf">leaderConfig</span><span class="p">,</span>
            <span class="n">LeaderCallbackHandler</span> <span class="nf">leaderCallbackHandler</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="nf">LeaderElectionConfig</span> <span class="n">leaderElectionConfig</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">LeaderElectionConfigBuilder</span><span class="p">()</span>
                        <span class="p">.</span><span class="na">withName</span><span class="p">(</span><span class="n">leaderConfig</span><span class="p">.</span><span class="na">getConfigMapName</span><span class="p">())</span>
                        <span class="p">.</span><span class="na">withLeaseDuration</span><span class="p">(</span><span class="n">leaderConfig</span><span class="p">.</span><span class="na">getLeaseDuration</span><span class="p">())</span>
                        <span class="p">.</span><span class="na">withLock</span><span class="p">(</span>
                                <span class="k">new</span> <span class="n">ConfigMapLock</span><span class="p">(</span>
                                        <span class="n">kubernetesClient</span><span class="p">.</span><span class="na">getNamespace</span><span class="p">(),</span>
                                        <span class="n">leaderConfig</span><span class="p">.</span><span class="na">getConfigMapName</span><span class="p">(),</span>
                                        <span class="n">leaderConfig</span><span class="p">.</span><span class="na">getLockIdentity</span><span class="p">())</span> <span class="cm">/*唯一标识*/</span><span class="p">)</span>
                        <span class="p">.</span><span class="na">withRenewDeadline</span><span class="p">(</span><span class="n">leaderConfig</span><span class="p">.</span><span class="na">getRenewDeadline</span><span class="p">())</span>
                        <span class="p">.</span><span class="na">withRetryPeriod</span><span class="p">(</span><span class="n">leaderConfig</span><span class="p">.</span><span class="na">getRetryPeriod</span><span class="p">())</span>
                        <span class="p">.</span><span class="na">withLeaderCallbacks</span><span class="p">(</span>
                                <span class="k">new</span> <span class="n">LeaderCallbacks</span><span class="p">(</span>
                                        <span class="n">leaderCallbackHandler</span><span class="o">::</span><span class="n">isLeader</span><span class="p">,</span> <span class="c1">//回调
</span><span class="c1"></span>                                        <span class="n">leaderCallbackHandler</span><span class="o">::</span><span class="n">notLeader</span><span class="p">,</span> <span class="c1">//回调
</span><span class="c1"></span>                                        <span class="n">newLeader</span> <span class="o">-&gt;</span> <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;New leader elected {} for {}.&#34;</span><span class="p">,</span> <span class="n">newLeader</span><span class="p">,</span><span class="n">leaderConfig</span><span class="p">.</span><span class="na">getConfigMapName</span><span class="p">())))</span>
                        <span class="p">.</span><span class="na">build</span><span class="p">();</span>
        <span class="n">internalLeaderElector</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LeaderElector</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">kubernetesClient</span><span class="p">,</span> <span class="n">leaderElectionConfig</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 变为非阻塞操作
</span><span class="c1"></span>    <span class="kd">public</span> <span class="nf">void</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">executorService</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="n">internalLeaderElector</span><span class="o">::</span><span class="n">run</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="nf">static</span> <span class="kt">boolean</span> <span class="nf">hasLeadership</span><span class="p">(</span><span class="n">KubernetesConfigMap</span> <span class="nf">configMap</span><span class="p">,</span> <span class="n">String</span> <span class="nf">lockIdentity</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="nf">String</span> <span class="n">leader</span> <span class="o">=</span> <span class="n">configMap</span><span class="p">.</span><span class="na">getAnnotations</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">LEADER_ANNOTATION_KEY</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">leader</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">leader</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">lockIdentity</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">KubernetesLeaderElectionDriver</span> <span class="nf">implements</span> <span class="n">LeaderElectionDriver</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="nf">final</span> <span class="n">String</span> <span class="nf">configMapName</span><span class="p">;</span> <span class="c1">// 用于 leader 选举、发布 leader 地址的 config map
</span><span class="c1"></span>    <span class="kd">private</span> <span class="nf">final</span> <span class="n">String</span> <span class="nf">lockIdentity</span><span class="p">;</span> <span class="c1">// 唯一标识，用于识别是否 leader
</span><span class="c1"></span>
    <span class="kd">public</span> <span class="nf">KubernetesLeaderElectionDriver</span><span class="p">(</span>
            <span class="n">FlinkKubeClient</span> <span class="nf">kubeClient</span><span class="p">,</span>
            <span class="n">KubernetesLeaderElectionConfiguration</span> <span class="nf">leaderConfig</span><span class="p">,</span>
            <span class="n">LeaderElectionEventHandler</span> <span class="nf">leaderElectionEventHandler</span><span class="p">,</span>
            <span class="n">FatalErrorHandler</span> <span class="nf">fatalErrorHandler</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">this</span><span class="p">.</span><span class="na">kubeClient</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="p">(</span><span class="n">kubeClient</span><span class="p">,</span> <span class="s">&#34;Kubernetes client&#34;</span><span class="p">);</span>
        <span class="n">checkNotNull</span><span class="p">(</span><span class="n">leaderConfig</span><span class="p">,</span> <span class="s">&#34;Leader election configuration&#34;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">leaderElectionEventHandler</span> <span class="o">=</span>
                <span class="n">checkNotNull</span><span class="p">(</span><span class="n">leaderElectionEventHandler</span><span class="p">,</span> <span class="s">&#34;LeaderElectionEventHandler&#34;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">fatalErrorHandler</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="p">(</span><span class="n">fatalErrorHandler</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="na">configMapName</span> <span class="o">=</span> <span class="n">leaderConfig</span><span class="p">.</span><span class="na">getConfigMapName</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="na">lockIdentity</span> <span class="o">=</span> <span class="n">leaderConfig</span><span class="p">.</span><span class="na">getLockIdentity</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="na">leaderElector</span> <span class="o">=</span> <span class="n">kubeClient</span><span class="p">.</span><span class="na">createLeaderElector</span><span class="p">(</span><span class="n">leaderConfig</span><span class="p">,</span> <span class="k">new</span> <span class="n">LeaderCallbackHandlerImpl</span><span class="p">());</span>
        <span class="k">this</span><span class="p">.</span><span class="na">configMapLabels</span> <span class="o">=</span>
                <span class="n">KubernetesUtils</span><span class="p">.</span><span class="na">getConfigMapLabels</span><span class="p">(</span>
                        <span class="n">leaderConfig</span><span class="p">.</span><span class="na">getClusterId</span><span class="p">(),</span> <span class="n">LABEL_CONFIGMAP_TYPE_HIGH_AVAILABILITY</span><span class="p">);</span>

        <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="n">leaderElector</span><span class="p">.</span><span class="na">run</span><span class="p">();</span>
        <span class="c1">// 监听 config map 变化
</span><span class="c1"></span>        <span class="n">kubernetesWatch</span> <span class="o">=</span> <span class="n">kubeClient</span><span class="p">.</span><span class="na">watchConfigMaps</span><span class="p">(</span><span class="n">configMapName</span><span class="p">,</span> <span class="k">new</span> <span class="n">ConfigMapCallbackHandlerImpl</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在选举完成后，会将 Leader 信息写入对应的 ConfigMap 中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">KubernetesLeaderElectionDriver</span> <span class="nf">implements</span> <span class="n">LeaderElectionDriver</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">writeLeaderInformation</span><span class="p">(</span><span class="n">LeaderInformation</span> <span class="nf">leaderInformation</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">running</span><span class="p">);</span>
        <span class="kd">final</span> <span class="nf">UUID</span> <span class="n">confirmedLeaderSessionID</span> <span class="o">=</span> <span class="n">leaderInformation</span><span class="p">.</span><span class="na">getLeaderSessionID</span><span class="p">();</span>
        <span class="kd">final</span> <span class="nf">String</span> <span class="n">confirmedLeaderAddress</span> <span class="o">=</span> <span class="n">leaderInformation</span><span class="p">.</span><span class="na">getLeaderAddress</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">kubeClient</span><span class="p">.</span><span class="na">checkAndUpdateConfigMap</span><span class="p">(</span> <span class="c1">// 封装的 CAS 操作，基于 ResourceVersion
</span><span class="c1"></span>                            <span class="n">configMapName</span><span class="p">,</span>
                            <span class="n">configMap</span> <span class="o">-&gt;</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">KubernetesLeaderElector</span><span class="p">.</span><span class="na">hasLeadership</span><span class="p">(</span><span class="n">configMap</span><span class="p">,</span> <span class="n">lockIdentity</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="c1">// Get the updated ConfigMap with new leader information
</span><span class="c1"></span>                                    <span class="k">if</span> <span class="p">(</span><span class="n">confirmedLeaderAddress</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">configMap</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">LEADER_ADDRESS_KEY</span><span class="p">);</span>
                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                        <span class="n">configMap</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">LEADER_ADDRESS_KEY</span><span class="p">,</span> <span class="n">confirmedLeaderAddress</span><span class="p">);</span>
                                    <span class="p">}</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">confirmedLeaderSessionID</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">configMap</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">LEADER_SESSION_ID_KEY</span><span class="p">);</span>
                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                        <span class="n">configMap</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">LEADER_SESSION_ID_KEY</span><span class="p">,</span> <span class="n">confirmedLeaderSessionID</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
                                    <span class="p">}</span>
                                    <span class="n">configMap</span><span class="p">.</span><span class="na">getLabels</span><span class="p">().</span><span class="na">putAll</span><span class="p">(</span><span class="n">configMapLabels</span><span class="p">);</span>
                                    <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">configMap</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
                            <span class="p">}).</span><span class="na">get</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="服务发现-2">服务发现</h3>

<p>Leader 的地址信息写入了 ConfigMap 中，因此直接从 ConfigMap 中直接取出响应的信息即可。 Kubernetes client 也支持在 ConfigMap 上设置监听器，监听 ConfigMap 的变更。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">KubernetesLeaderRetrievalDriver</span> <span class="nf">implements</span> <span class="n">LeaderRetrievalDriver</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">KubernetesLeaderRetrievalDriver</span><span class="p">(</span>
        <span class="n">FlinkKubeClient</span> <span class="nf">kubeClient</span><span class="p">,</span>
        <span class="n">String</span> <span class="nf">configMapName</span><span class="p">,</span>
        <span class="n">LeaderRetrievalEventHandler</span> <span class="nf">leaderRetrievalEventHandler</span><span class="p">,</span>
        <span class="n">FatalErrorHandler</span> <span class="nf">fatalErrorHandler</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">kubeClient</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="p">(</span><span class="n">kubeClient</span><span class="p">,</span> <span class="s">&#34;Kubernetes client&#34;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">configMapName</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="p">(</span><span class="n">configMapName</span><span class="p">,</span> <span class="s">&#34;ConfigMap name&#34;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">leaderRetrievalEventHandler</span> <span class="o">=</span>
                <span class="n">checkNotNull</span><span class="p">(</span><span class="n">leaderRetrievalEventHandler</span><span class="p">,</span> <span class="s">&#34;LeaderRetrievalEventHandler&#34;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">fatalErrorHandler</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="p">(</span><span class="n">fatalErrorHandler</span><span class="p">);</span>

        <span class="n">kubernetesWatch</span> <span class="o">=</span> <span class="n">kubeClient</span><span class="p">.</span><span class="na">watchConfigMaps</span><span class="p">(</span><span class="n">configMapName</span><span class="p">,</span> <span class="k">new</span> <span class="n">ConfigMapCallbackHandlerImpl</span><span class="p">());</span>

        <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="nf">class</span> <span class="n">ConfigMapCallbackHandlerImpl</span>
        <span class="nf">implements</span> <span class="n">FlinkKubeClient</span><span class="p">.</span><span class="na">WatchCallbackHandler</span><span class="o">&lt;</span><span class="n">KubernetesConfigMap</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nf">void</span> <span class="n">onModified</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">KubernetesConfigMap</span><span class="o">&gt;</span> <span class="nf">configMaps</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">final</span> <span class="nf">KubernetesConfigMap</span> <span class="n">configMap</span> <span class="o">=</span> <span class="n">checkConfigMaps</span><span class="p">(</span><span class="n">configMaps</span><span class="p">,</span> <span class="n">configMapName</span><span class="p">);</span>
            <span class="n">leaderRetrievalEventHandler</span><span class="p">.</span><span class="na">notifyLeaderAddress</span><span class="p">(</span><span class="n">getLeaderInformationFromConfigMap</span><span class="p">(</span><span class="n">configMap</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="状态保存-2">状态保存</h3>

<p>和 ZooKeeper 一样，Kubernetes 的 ConfigMap 只保存轻量的数据，对于一些比较大的数据，先写入外部文件系统，然后将元数据写入 ConfigMap 中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">KubernetesRunningJobsRegistry</span> <span class="nf">implements</span> <span class="n">RunningJobsRegistry</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">void</span> <span class="n">setJobRunning</span><span class="p">(</span><span class="n">JobID</span> <span class="nf">jobID</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
        <span class="n">writeJobStatusToConfigMap</span><span class="p">(</span><span class="n">jobID</span><span class="p">,</span> <span class="n">JobSchedulingStatus</span><span class="p">.</span><span class="na">RUNNING</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="nf">void</span> <span class="n">writeJobStatusToConfigMap</span><span class="p">(</span><span class="n">JobID</span> <span class="nf">jobID</span><span class="p">,</span> <span class="n">JobSchedulingStatus</span> <span class="nf">status</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="nf">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">getKeyForJobId</span><span class="p">(</span><span class="n">jobID</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">kubeClient</span><span class="p">.</span><span class="na">checkAndUpdateConfigMap</span><span class="p">(</span>
                            <span class="n">configMapName</span><span class="p">,</span>
                            <span class="n">configMap</span> <span class="o">-&gt;</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">KubernetesLeaderElector</span><span class="p">.</span><span class="na">hasLeadership</span><span class="p">(</span><span class="n">configMap</span><span class="p">,</span> <span class="n">lockIdentity</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="kd">final</span> <span class="nf">Optional</span><span class="o">&lt;</span><span class="n">JobSchedulingStatus</span><span class="o">&gt;</span> <span class="nf">optional</span> <span class="o">=</span> <span class="n">getJobStatus</span><span class="p">(</span><span class="n">configMap</span><span class="p">,</span> <span class="n">jobID</span><span class="p">);</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">optional</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span> <span class="o">||</span> <span class="n">optional</span><span class="p">.</span><span class="na">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">configMap</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">status</span><span class="p">.</span><span class="na">name</span><span class="p">());</span>
                                        <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">configMap</span><span class="p">);</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                                <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
                            <span class="p">}).</span><span class="na">get</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">KubernetesStateHandleStore</span><span class="o">&lt;</span><span class="n">T</span> <span class="nf">extends</span> <span class="n">Serializable</span><span class="o">&gt;</span>
        <span class="nf">implements</span> <span class="n">StateHandleStore</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">StringResourceVersion</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">RetrievableStateHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">addAndLock</span><span class="p">(</span><span class="n">String</span> <span class="nf">key</span><span class="p">,</span> <span class="n">T</span> <span class="nf">state</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>

        <span class="c1">// 写入外部文件系统
</span><span class="c1"></span>        <span class="kd">final</span> <span class="nf">RetrievableStateHandle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">storeHandle</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="na">store</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

        <span class="kt">boolean</span> <span class="nf">success</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">final</span> <span class="nf">byte</span><span class="p">[]</span> <span class="n">serializedStoreHandle</span> <span class="o">=</span> <span class="n">InstantiationUtil</span><span class="p">.</span><span class="na">serializeObject</span><span class="p">(</span><span class="n">storeHandle</span><span class="p">);</span>
            <span class="n">success</span> <span class="o">=</span>
                    <span class="n">kubeClient</span><span class="p">.</span><span class="na">checkAndUpdateConfigMap</span><span class="p">(</span>
                                    <span class="n">configMapName</span><span class="p">,</span>
                                    <span class="n">c</span> <span class="o">-&gt;</span> <span class="p">{</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="n">KubernetesLeaderElector</span><span class="p">.</span><span class="na">hasLeadership</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">lockIdentity</span><span class="p">))</span> <span class="p">{</span>
                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">containsKey</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
                                                <span class="n">c</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">encodeStateHandle</span><span class="p">(</span><span class="n">serializedStoreHandle</span><span class="p">));</span>
                                                <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                                <span class="k">throw</span> <span class="k">new</span> <span class="n">CompletionException</span><span class="p">(</span><span class="n">etKeyAlreadyExistException</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
                                            <span class="p">}</span>
                                        <span class="p">}</span>
                                        <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
                                    <span class="p">})</span>
                            <span class="p">.</span><span class="na">get</span><span class="p">();</span>
            <span class="k">return</span> <span class="n">storeHandle</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">findThrowable</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">AlreadyExistException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
                    <span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">ex</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Cleanup the state handle if it was not written to ConfigMap.
</span><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">storeHandle</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">storeHandle</span><span class="p">.</span><span class="na">discardState</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="checkpointidcount-1">CheckpointIDCount</h3>

<p>CheckpointID 在 Kubernetes 中也是保存在 ConfigMap 中的，借助 CAS 更新实现原子操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">KubernetesCheckpointIDCounter</span> <span class="nf">implements</span> <span class="n">CheckpointIDCounter</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nf">long</span> <span class="n">getAndIncrement</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">Exception</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="nf">AtomicLong</span> <span class="n">current</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicLong</span><span class="p">();</span>
        <span class="kd">final</span> <span class="nf">boolean</span> <span class="n">updated</span> <span class="o">=</span>
                <span class="n">kubeClient</span><span class="p">.</span><span class="na">checkAndUpdateConfigMap</span><span class="p">(</span>
                                <span class="n">configMapName</span><span class="p">,</span>
                                <span class="n">configMap</span> <span class="o">-&gt;</span> <span class="p">{</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">KubernetesLeaderElector</span><span class="p">.</span><span class="na">hasLeadership</span><span class="p">(</span><span class="n">configMap</span><span class="p">,</span> <span class="n">lockIdentity</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="kd">final</span> <span class="nf">long</span> <span class="n">currentValue</span> <span class="o">=</span> <span class="n">getCurrentCounter</span><span class="p">(</span><span class="n">configMap</span><span class="p">);</span>
                                        <span class="n">current</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">currentValue</span><span class="p">);</span>
                                        <span class="n">configMap</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">CHECKPOINT_COUNTER_KEY</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">currentValue</span> <span class="o">+</span> <span class="n">1</span><span class="p">));</span>
                                        <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">configMap</span><span class="p">);</span>
                                    <span class="p">}</span>
                                    <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
                                <span class="p">}).</span><span class="na">get</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">current</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="小结">小结</h2>

<p>总的来说，通过 Leader 选举、服务发现、状态存储这几个服务，在 Flink 中可以方便地对 HA 的底层实现进行扩展。Flink 提供的基于 Kubernetes 的 HA 实现可以简化 Flink on Kubernetes 的部署方式。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/ha/">JobManager High Availability (HA)</a><br /></li>
<li><a href="https://cwiki.apache.org/confluence/display/FLINK/FLIP-144%3A+Native+Kubernetes+HA+for+Flink">FLIP-144: Native Kubernetes HA for Flink</a><br /></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"><a rel="license noopener" href="https://blog.jrwang.me" target="_blank">jrthe42</a></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">原始链接</span>
    <span class="item-content"><a href="https://blog.jrwang.me/2020/2020-12-26-flink-ha/">https://blog.jrwang.me/2020/2020-12-26-flink-ha/</a></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-03-23
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/flink/">Flink</a>
          <a href="/tags/%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97/">实时计算</a>
          <a href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/">高可用</a>
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2019/aloha-introduce/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Aloha：一个分布式任务调度框架</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/2020/2020-12-20-flink-sourcecode-mailbox-threading-model/">
            <span class="next-text nav-default">Flink 源码阅读笔记（20）- Flink 基于 Mailbox 的线程模型</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="jrthe42/blog-comment"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:jrthe42@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/jrthe42" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/jrthe42" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://blog.jrwang.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2015 - 
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author"><a rel="license noopener" href="https://blog.jrwang.me" target="_blank">jrthe42</a></span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.f79f403f.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-66913886-2', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
