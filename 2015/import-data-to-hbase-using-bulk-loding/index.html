<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>使用 Bulk Load 快速向 HBase 中导入数据 - JR&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="jrthe42" /><meta name="description" content="前言 Apache HBase 是目前大数据系统中应用最为广泛的分布式数据库之一。我们经常面临向 HBase 中导入大量数据的情景，通常会选择使用标准的客户端 API 对 HBase 进行直接的操" /><meta name="keywords" content="jrthe42, Blog, Programming" />






<meta name="generator" content="Hugo 0.58.0 with theme even" />


<link rel="canonical" href="https://blog.jrwang.me/2015/import-data-to-hbase-using-bulk-loding/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.7d171193.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="使用 Bulk Load 快速向 HBase 中导入数据" />
<meta property="og:description" content="前言 Apache HBase 是目前大数据系统中应用最为广泛的分布式数据库之一。我们经常面临向 HBase 中导入大量数据的情景，通常会选择使用标准的客户端 API 对 HBase 进行直接的操" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.jrwang.me/2015/import-data-to-hbase-using-bulk-loding/" />
<meta property="article:published_time" content="2015-12-06T19:20:11+00:00" />
<meta property="article:modified_time" content="2015-12-06T19:20:11+00:00" />
<meta itemprop="name" content="使用 Bulk Load 快速向 HBase 中导入数据">
<meta itemprop="description" content="前言 Apache HBase 是目前大数据系统中应用最为广泛的分布式数据库之一。我们经常面临向 HBase 中导入大量数据的情景，通常会选择使用标准的客户端 API 对 HBase 进行直接的操">


<meta itemprop="datePublished" content="2015-12-06T19:20:11&#43;00:00" />
<meta itemprop="dateModified" content="2015-12-06T19:20:11&#43;00:00" />
<meta itemprop="wordCount" content="2571">



<meta itemprop="keywords" content="HBase,MapReduce,Original," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用 Bulk Load 快速向 HBase 中导入数据"/>
<meta name="twitter:description" content="前言 Apache HBase 是目前大数据系统中应用最为广泛的分布式数据库之一。我们经常面临向 HBase 中导入大量数据的情景，通常会选择使用标准的客户端 API 对 HBase 进行直接的操"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">JRTHE42</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">JRTHE42</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">使用 Bulk Load 快速向 HBase 中导入数据</h1>

      <div class="post-meta">
        <span class="post-time"> 2015-12-06 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#bulk-load-简介">Bulk Load 简介</a>
<ul>
<li><a href="#从数据源中提取数据">从数据源中提取数据</a></li>
<li><a href="#通过-mapreduce-任务生成-hfile">通过 MapReduce 任务生成 HFile</a></li>
<li><a href="#完成数据导入">完成数据导入</a></li>
</ul></li>
<li><a href="#bulk-load实例">Bulk Load实例</a>
<ul>
<li><a href="#app-java">App.java</a></li>
<li><a href="#recordmapper-java">RecordMapper.java</a></li>
<li><a href="#utils-java">Utils.java</a></li>
</ul></li>
<li><a href="#其他说明">其他说明</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h3 id="前言">前言</h3>

<p>Apache HBase 是目前大数据系统中应用最为广泛的分布式数据库之一。我们经常面临向 HBase 中导入大量数据的情景，通常会选择使用标准的客户端 API 对 HBase 进行直接的操作，或者在MapReduce作业中使用 TableOutputFormat 作为输出。实际上，借助 HBase 的 Bulk Load 特性可以更加便捷、快速地向HBase数据库中导入数据。</p>

<p>MapReduce 在写入 HBase 时常采用 TableOutputFormat 方式，直接写入 HBase，但该方式在大量数据写入时效率比较低下（频繁进行 flush、split、compat等I/O操作），并对 HBase 节点稳定性造成影响（ RegionServer 无响应）。</p>

<p>HBase的数据实际上是以特定格式存储在 HDFS 上的，因而 Bulk Load 就是先将数据按照HBase的内部数据格式生成持久化的 HFile 文件，然后复制到合适的位置并通知 RegionServer ，即完成巨量数据的入库。在生成 HFile 时无需占用 Region 资源，降低了 HBase 节点的写入压力，在大量数据写入时能极大地提高写入效率。</p>

<h3 id="bulk-load-简介">Bulk Load 简介</h3>

<p>使用 Bulk Load 特性将数据导入 HBase 通常需要分为三个阶段：</p>

<h4 id="从数据源中提取数据">从数据源中提取数据</h4>

<p>通常需要导入的外部数据都是存储在其它的关系型数据库或一些文本文件中，我们需要将数据提取出来并放置于 HDFS 中。借助 Sqoop 这一工具可以解决大多数关系型数据库向 HDFS 迁移数据的问题。</p>

<h4 id="通过-mapreduce-任务生成-hfile">通过 MapReduce 任务生成 HFile</h4>

<p>在进行数据导入时，需要对数据进行预处理，如过滤无效数据、数据格式转换等。通常按照不同的导入要求，需要编写不同的 Mapper；Reducer 由 HBase 负责处理。为了按照 HBase 内部存储格式生成数据，一个重要的类是 <code>HFileOutputFormat2</code>(HBase 1.0.0以前版本使用 <code>HFileOutputFormat</code>)。为了更有效地导入数据， 每一个输出的 HFile 要恰好适应一个 Region。为了确保这一点， 需要使用 <code>TotalOrderPartitioner</code> 类将 map 的输出切分为 key 互不相交的部分。<code>HFileOutputFormat2</code> 类中的 <code>configureIncrementalLoad()</code> 方法会依据当前表中的 Region 边界自动设置 <code>TotalOrderPartitioner</code>。</p>

<h4 id="完成数据导入">完成数据导入</h4>

<p>一旦数据准备好，就可以使用 <code>completebulkload</code> 工具将生成的 HFile 导入HBase 集群中。<code>completebulkload</code> 是一个命令行工具，对生成的 HFile 文件迭代进行处理，对每一个 HFile， 确定所属的 region， 然后联系对应的 RegionServer， 将数据移动至相应的存储路径。</p>

<p>如果在准备数据过程中，或者在使用 <code>completebulkload</code> 导入数据过程中， region 的边界发生了改变（split）， <code>completebulkload</code> 工具会按照新的边界自动切分数据文件。这个过程可能会对性能造成影响。</p>

<p>除了使用 <code>completebulkload</code> 工具外，也可以在程序中完成, <code>LoadIncrementalHFiles</code> 类提供了相应的方法。</p>

<h3 id="bulk-load实例">Bulk Load实例</h3>

<p>这里给出一个简单的例子，旨在说明如何使用 MapReduce 和 Bulk Load 将数据导入到HBase中。这里不介绍如何将数据迁移至 HDFS 中，重点关注 HFile 的生成及载入。</p>

<h4 id="app-java">App.java</h4>

<p>创建 MapReduce 作业</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nf">static</span> <span class="n">Job</span> <span class="nf">createCommitableJob</span><span class="p">(</span><span class="n">String</span> <span class="nf">tableNameStr</span><span class="p">,</span> <span class="n">String</span> <span class="nf">inputPathStr</span><span class="p">,</span> <span class="n">String</span> <span class="nf">outputPathStr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Configuration</span> <span class="nf">conf</span> <span class="o">=</span> <span class="n">HBaseConfiguration</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="k">new</span> <span class="n">Configuration</span><span class="p">());</span>
    <span class="n">JobClient</span> <span class="nf">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JobClient</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

    <span class="n">Path</span> <span class="nf">inputPath</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Path</span><span class="p">(</span><span class="n">inputPathStr</span><span class="p">);</span>
    <span class="n">Path</span> <span class="nf">outputPath</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Path</span><span class="p">(</span><span class="n">outputPathStr</span><span class="p">);</span>

    <span class="n">Job</span> <span class="nf">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s">&#34;load_data_to_&#34;</span> <span class="o">+</span> <span class="n">tableNameStr</span><span class="p">);</span>
    <span class="n">job</span><span class="p">.</span><span class="na">setJarByClass</span><span class="p">(</span><span class="n">App</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="n">FileInputFormat</span><span class="p">.</span><span class="na">setInputPaths</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">inputPath</span><span class="p">);</span>
    <span class="n">job</span><span class="p">.</span><span class="na">setInputFormatClass</span><span class="p">(</span><span class="n">TextInputFormat</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="c1">//set mapper class according to job type.
</span><span class="c1"></span>    <span class="k">switch</span> <span class="p">(</span><span class="n">tableNameStr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">RECORD</span><span class="o">:</span>
            <span class="n">job</span><span class="p">.</span><span class="na">setMapperClass</span><span class="p">(</span><span class="n">RecordMapper</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">XXX</span><span class="o">:</span>
            <span class="n">job</span><span class="p">.</span><span class="na">setMapperClass</span><span class="p">(</span><span class="n">XXXMapper</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">XXXX</span><span class="o">:</span>
            <span class="n">job</span><span class="p">.</span><span class="na">setMapperClass</span><span class="p">(</span><span class="n">XXXXMapper</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">job</span><span class="p">.</span><span class="na">setMapOutputKeyClass</span><span class="p">(</span><span class="n">ImmutableBytesWritable</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="n">job</span><span class="p">.</span><span class="na">setMapOutputValueClass</span><span class="p">(</span><span class="n">Put</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="n">job</span><span class="p">.</span><span class="na">setReducerClass</span><span class="p">(</span><span class="n">PutSortReducer</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="n">FileSystem</span> <span class="nf">hdfs</span> <span class="o">=</span> <span class="n">FileSystem</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">hdfs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hdfs</span><span class="p">.</span><span class="na">exists</span><span class="p">(</span><span class="n">outputPath</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">hdfs</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">FileOutputFormat</span><span class="p">.</span><span class="na">setOutputPath</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">outputPath</span><span class="p">);</span>

    <span class="c1">//for hbase version 1.0.0+
</span><span class="c1"></span>    <span class="n">Connection</span> <span class="nf">connection</span> <span class="o">=</span> <span class="n">ConnectionFactory</span><span class="p">.</span><span class="na">createConnection</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
    <span class="n">TableName</span> <span class="nf">tableName</span> <span class="o">=</span> <span class="n">TableName</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">tableNameStr</span><span class="p">);</span>
    <span class="n">Table</span> <span class="nf">table</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="na">getTable</span><span class="p">(</span><span class="n">tableName</span><span class="p">);</span>
    <span class="n">HFileOutputFormat2</span><span class="p">.</span><span class="na">configureIncrementalLoad</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span><span class="n">connection</span><span class="p">.</span><span class="na">getRegionLocator</span><span class="p">(</span><span class="n">tableName</span><span class="p">));</span>

    <span class="c1">//for hbase 0.96
</span><span class="c1"></span>    <span class="cm">/*HTable table = new HTable(conf, tableNameStr);
</span><span class="cm">    HFileOutputFormat.configureIncrementalLoad(job, table);
</span><span class="cm">    TableMapReduceUtil.addDependencyJars(job);
</span><span class="cm">    TableMapReduceUtil.addDependencyJars(job.getConfiguration(), com.google.common.base.Function.class);*/</span>

    <span class="k">return</span> <span class="n">job</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>运行 MapReduce 作业</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="c1">//先一些初始化操作，获取作业基本信息，如路径、表名等。
</span><span class="c1"></span>    <span class="c1">//创建 MapReduce 作业
</span><span class="c1"></span>    <span class="n">Job</span> <span class="nf">job</span> <span class="o">=</span> <span class="n">createCommitableJob</span><span class="p">(</span><span class="n">tableNameStr</span><span class="p">,</span> <span class="n">inputPathStr</span><span class="p">,</span> <span class="n">outputPathStr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">job</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;Error in create job!&#34;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">waitForCompletion</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">Counter</span> <span class="nf">counter</span> <span class="o">=</span> <span class="n">job</span><span class="p">.</span><span class="na">getCounters</span><span class="p">().</span><span class="na">findCounter</span><span class="p">(</span><span class="n">TaskCounter</span><span class="p">.</span><span class="na">MAP_OUTPUT_RECORDS</span><span class="p">);</span>
        <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;job finished, total &#34;</span> <span class="o">+</span> <span class="n">counter</span><span class="p">.</span><span class="na">getValue</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34; records!&#34;</span><span class="p">);</span>

        <span class="c1">//完成 mapreduce 作业后，使用 bulk load导入数据
</span><span class="c1"></span>        <span class="n">Utils</span><span class="p">.</span><span class="na">doBulkLoad</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">hfilePathStr</span><span class="p">,</span> <span class="n">tableNameStr</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//作业运行失败
</span><span class="c1"></span>        <span class="n">LOG</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;job failed!&#34;</span><span class="p">);</span>
    <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="recordmapper-java">RecordMapper.java</h4>

<p>定制 Mapper 类，负责对数据进行预处理，如过滤，转换等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">RecordMapper</span> <span class="nf">extends</span> <span class="n">Mapper</span><span class="o">&lt;</span><span class="n">LongWritable</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span> <span class="n">ImmutableBytesWritable</span><span class="p">,</span> <span class="n">Put</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="nf">static</span> <span class="kd">final</span> <span class="nf">byte</span><span class="p">[]</span> <span class="n">FAMILY_BYTE</span> <span class="o">=</span> <span class="n">Bytes</span><span class="p">.</span><span class="na">toBytes</span><span class="p">(</span><span class="n">CommonConfig</span><span class="p">.</span><span class="na">HBASE_FAMILY</span><span class="p">);</span>
    <span class="kd">private</span> <span class="nf">static</span> <span class="kd">final</span> <span class="nf">byte</span><span class="p">[]</span> <span class="n">QUALIFER_BYTE</span> <span class="o">=</span> <span class="n">Bytes</span><span class="p">.</span><span class="na">toBytes</span><span class="p">(</span><span class="n">CommonConfig</span><span class="p">.</span><span class="na">HBASE_QUALIFER</span><span class="p">);</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nf">void</span> <span class="n">setup</span><span class="p">(</span><span class="n">Context</span> <span class="nf">context</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span><span class="p">,</span> <span class="n">InterruptedException</span> <span class="p">{</span>
        <span class="c1">//一些准备工作
</span><span class="c1"></span>        <span class="c1">//...
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nf">void</span> <span class="n">map</span><span class="p">(</span><span class="n">LongWritable</span> <span class="nf">key</span><span class="p">,</span> <span class="n">Text</span> <span class="nf">value</span><span class="p">,</span> <span class="n">Context</span> <span class="nf">context</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span><span class="p">,</span> <span class="n">InterruptedException</span> <span class="p">{</span>
        <span class="n">String</span> <span class="nf">record</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
        <span class="c1">//过滤无效数据
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">isVaild</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">//数据处理，如格式转换等操作
</span><span class="c1"></span>            <span class="c1">//获取RowKey
</span><span class="c1"></span>            <span class="kt">byte</span><span class="p">[]</span> <span class="nf">rkValu</span> <span class="o">=</span> <span class="n">getRowKey</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
            <span class="n">ImmutableBytesWritable</span> <span class="nf">rowKey</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ImmutableBytesWritable</span><span class="p">(</span><span class="n">rkValue</span><span class="p">);</span>
            <span class="c1">//创建Put对象
</span><span class="c1"></span>            <span class="n">Put</span> <span class="nf">put</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Put</span><span class="p">(</span><span class="n">rowKey</span><span class="p">.</span><span class="na">copyBytes</span><span class="p">());</span>

            <span class="c1">//获取TimeStamp
</span><span class="c1"></span>            <span class="kt">long</span> <span class="nf">timestamp</span> <span class="o">=</span> <span class="n">getTimeStamp</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>

            <span class="c1">//获取应该插入到HBase中的一个cell
</span><span class="c1"></span>            <span class="n">String</span> <span class="nf">cellValue</span> <span class="o">=</span> <span class="n">getCellValue</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>

            <span class="c1">//将待插入数据存放至Put对象中
</span><span class="c1"></span>            <span class="n">put</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">FAMILY_BYTE</span><span class="p">,</span> <span class="n">QUALIFER_BYTE</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">Bytes</span><span class="p">.</span><span class="na">toBytes</span><span class="p">(</span><span class="n">cellValue</span><span class="p">));</span>
            <span class="n">context</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">rowKey</span><span class="p">,</span> <span class="n">put</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nf">void</span> <span class="n">cleanup</span><span class="p">(</span><span class="n">Context</span> <span class="nf">context</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span><span class="p">,</span> <span class="n">InterruptedException</span> <span class="p">{</span>
        <span class="c1">//map完成后的一些清理工作
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="utils-java">Utils.java</h4>

<p>一些辅助方法。这里给出如何在程序中直接使用 Bulk Load，而无需通过命令行工具。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * loading HFile in &#39;hFilePath&#39; to HBase, target HTable&#39;s name is &#39;tableNameStr&#39;
</span><span class="cm"> * @param  conf         Configuration instance
</span><span class="cm"> * @param  hFilePath
</span><span class="cm"> * @param  tableNameStr
</span><span class="cm"> * @throws Exception
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="nf">static</span> <span class="kt">void</span> <span class="nf">doBulkLoad</span><span class="p">(</span><span class="n">Configuration</span> <span class="nf">conf</span><span class="p">,</span> <span class="n">String</span> <span class="nf">hFilePath</span><span class="p">,</span> <span class="n">String</span> <span class="nf">tableNameStr</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">Exception</span><span class="p">{</span>
    <span class="c1">//change permission first.
</span><span class="c1"></span>    <span class="n">FileSystem</span> <span class="nf">fs</span> <span class="o">=</span> <span class="n">FileSystem</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
    <span class="n">chmod</span><span class="p">(</span><span class="k">new</span> <span class="n">Path</span><span class="p">(</span><span class="n">hFilePath</span><span class="p">),</span> <span class="n">fs</span><span class="p">);</span>
    <span class="c1">//do bulk load.
</span><span class="c1"></span>    <span class="n">HBaseConfiguration</span><span class="p">.</span><span class="na">addHbaseResources</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
    <span class="n">LoadIncrementalHFiles</span> <span class="nf">loadFiles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LoadIncrementalHFiles</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
    <span class="n">Connection</span> <span class="nf">connection</span> <span class="o">=</span> <span class="n">ConnectionFactory</span><span class="p">.</span><span class="na">createConnection</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
    <span class="n">TableName</span> <span class="nf">tableName</span> <span class="o">=</span> <span class="n">TableName</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">tableNameStr</span><span class="p">);</span>
    <span class="n">Table</span> <span class="nf">table</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="na">getTable</span><span class="p">(</span><span class="n">tableName</span><span class="p">);</span>
    <span class="n">loadFiles</span><span class="p">.</span><span class="na">doBulkLoad</span><span class="p">(</span><span class="k">new</span> <span class="n">Path</span><span class="p">(</span><span class="n">hFilePath</span><span class="p">),</span> <span class="n">table</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>MapReduce 作业生成的文件存放在 HDFS 上时，其权限归运行 MapReduce 作业的用户所有。在使用 Bulk Load 导入数据时， 需要将权限赋给 hbase 用户。简单粗暴的方法就是将文件夹的权限改为“777”， 下面的方法实现了该功能。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * change the permission of a give path to 777, all subdir are changed recursively.
</span><span class="cm"> * @param path
</span><span class="cm"> * @param fs
</span><span class="cm"> * @throws IOException
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="nf">static</span> <span class="kt">void</span> <span class="nf">chmod</span><span class="p">(</span><span class="n">Path</span> <span class="nf">path</span><span class="p">,</span> <span class="n">FileSystem</span> <span class="nf">fs</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
    <span class="n">fs</span><span class="p">.</span><span class="na">setPermission</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">FsPermission</span><span class="p">.</span><span class="na">createImmutable</span><span class="p">(</span><span class="n">FULL_GRANTS</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="na">getFileStatus</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="na">isFile</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">RemoteIterator</span><span class="o">&lt;</span><span class="n">LocatedFileStatus</span><span class="o">&gt;</span> <span class="nf">fileStatuses</span> <span class="o">=</span> <span class="n">fs</span><span class="p">.</span><span class="na">listLocatedStatus</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="n">fileStatuses</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">LocatedFileStatus</span> <span class="nf">status</span> <span class="o">=</span> <span class="n">fileStatuses</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fs</span><span class="p">.</span><span class="na">setPermission</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="na">getPath</span><span class="p">(),</span> <span class="n">FsPermission</span><span class="p">.</span><span class="na">createImmutable</span><span class="p">(</span><span class="n">FULL_GRANTS</span><span class="p">));</span>
            <span class="n">chmod</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="na">getPath</span><span class="p">(),</span> <span class="n">fs</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="其他说明">其他说明</h3>

<ol>
<li><p>在 <code>HFileOutputFormat2.configureIncrementalLoad</code> 方法中，MapReduce 作业的很多配置都自动完成了。从源码中可以看出，该方法中主要完成了以下几点：</p>

<ul>
<li>设置作业输出的 key、value 类为 <code>ImmutableBytesWritable</code> 和 <code>KeyValue</code></li>
<li>设置作业的 OutputFormat 类为 <code>HFileOutputFormat2.class</code></li>
<li>根据作业 Map 的输出设置合适 Reduce 类。Map 输出 key 必须为 ImmutableBytesWritable，Value 类型为 分别为 KeyValue、 Put、和 Text，对应的Reducer 分别为 <code>KeyValueSortReducer.class</code>、<code>PutSortReducer.class</code> 和 <code>TextSortReducer.class</code>。</li>
<li>根据当前 region 数量确定 Reduce 的数量</li>

<li><p>调用 <code>configurePartitioner</code> 方法配置 <code>TotalOrderPartitioner</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">static</span> <span class="kt">void</span> <span class="nf">configureIncrementalLoad</span><span class="p">(</span><span class="n">Job</span> <span class="nf">job</span><span class="p">,</span> <span class="n">HTableDescriptor</span> <span class="nf">tableDescriptor</span><span class="p">,</span>
<span class="n">RegionLocator</span> <span class="nf">regionLocator</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span> <span class="p">{</span>
<span class="n">configureIncrementalLoad</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">tableDescriptor</span><span class="p">,</span> <span class="n">regionLocator</span><span class="p">,</span> <span class="n">HFileOutputFormat2</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">static</span> <span class="nf">void</span> <span class="n">configureIncrementalLoad</span><span class="p">(</span><span class="n">Job</span> <span class="nf">job</span><span class="p">,</span> <span class="n">HTableDescriptor</span> <span class="nf">tableDescriptor</span><span class="p">,</span>
<span class="n">RegionLocator</span> <span class="nf">regionLocator</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nf">OutputFormat</span><span class="o">&lt;?</span><span class="p">,</span> <span class="o">?&gt;&gt;</span> <span class="n">cls</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IOException</span><span class="p">,</span>
<span class="n">UnsupportedEncodingException</span> <span class="p">{</span>
<span class="n">Configuration</span> <span class="nf">conf</span> <span class="o">=</span> <span class="n">job</span><span class="p">.</span><span class="na">getConfiguration</span><span class="p">();</span>
<span class="n">job</span><span class="p">.</span><span class="na">setOutputKeyClass</span><span class="p">(</span><span class="n">ImmutableBytesWritable</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="n">job</span><span class="p">.</span><span class="na">setOutputValueClass</span><span class="p">(</span><span class="n">KeyValue</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="n">job</span><span class="p">.</span><span class="na">setOutputFormatClass</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>

<span class="c1">// Based on the configured map output class, set the correct reducer to properly
</span><span class="c1">// sort the incoming values.
</span><span class="c1">// TODO it would be nice to pick one or the other of these formats.
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">KeyValue</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">getMapOutputValueClass</span><span class="p">()))</span> <span class="p">{</span>
<span class="n">job</span><span class="p">.</span><span class="na">setReducerClass</span><span class="p">(</span><span class="n">KeyValueSortReducer</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Put</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">getMapOutputValueClass</span><span class="p">()))</span> <span class="p">{</span>
<span class="n">job</span><span class="p">.</span><span class="na">setReducerClass</span><span class="p">(</span><span class="n">PutSortReducer</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Text</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">getMapOutputValueClass</span><span class="p">()))</span> <span class="p">{</span>
<span class="n">job</span><span class="p">.</span><span class="na">setReducerClass</span><span class="p">(</span><span class="n">TextSortReducer</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="n">LOG</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;Unknown map output value type:&#34;</span> <span class="o">+</span> <span class="n">job</span><span class="p">.</span><span class="na">getMapOutputValueClass</span><span class="p">());</span>
<span class="p">}</span>

<span class="n">conf</span><span class="p">.</span><span class="na">setStrings</span><span class="p">(</span><span class="s">&#34;io.serializations&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;io.serializations&#34;</span><span class="p">),</span>
  <span class="n">MutationSerialization</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span> <span class="n">ResultSerialization</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span>
  <span class="n">KeyValueSerialization</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>

<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="na">getBoolean</span><span class="p">(</span><span class="n">LOCALITY_SENSITIVE_CONF_KEY</span><span class="p">,</span> <span class="n">DEFAULT_LOCALITY_SENSITIVE</span><span class="p">))</span> <span class="p">{</span>
<span class="c1">// record this table name for creating writer by favored nodes
</span><span class="c1"></span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;bulkload locality sensitive enabled&#34;</span><span class="p">);</span>
<span class="n">conf</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">OUTPUT_TABLE_NAME_CONF_KEY</span><span class="p">,</span> <span class="n">regionLocator</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">getNameAsString</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">// Use table&#39;s region boundaries for TOP split points.
</span><span class="c1"></span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Looking up current regions for table &#34;</span> <span class="o">+</span> <span class="n">regionLocator</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">ImmutableBytesWritable</span><span class="o">&gt;</span> <span class="nf">startKeys</span> <span class="o">=</span> <span class="n">getRegionStartKeys</span><span class="p">(</span><span class="n">regionLocator</span><span class="p">);</span>
<span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Configuring &#34;</span> <span class="o">+</span> <span class="n">startKeys</span><span class="p">.</span><span class="na">size</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34; reduce partitions &#34;</span> <span class="o">+</span>
  <span class="s">&#34;to match current region count&#34;</span><span class="p">);</span>
<span class="n">job</span><span class="p">.</span><span class="na">setNumReduceTasks</span><span class="p">(</span><span class="n">startKeys</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>

<span class="n">configurePartitioner</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">startKeys</span><span class="p">);</span>
<span class="c1">// Set compression algorithms based on column families
</span><span class="c1"></span><span class="n">configureCompression</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">tableDescriptor</span><span class="p">);</span>
<span class="n">configureBloomType</span><span class="p">(</span><span class="n">tableDescriptor</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
<span class="n">configureBlockSize</span><span class="p">(</span><span class="n">tableDescriptor</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
<span class="n">configureDataBlockEncoding</span><span class="p">(</span><span class="n">tableDescriptor</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>

<span class="n">TableMapReduceUtil</span><span class="p">.</span><span class="na">addDependencyJars</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
<span class="n">TableMapReduceUtil</span><span class="p">.</span><span class="na">initCredentials</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
<span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Incremental table &#34;</span> <span class="o">+</span> <span class="n">regionLocator</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34; output configured.&#34;</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ul></li>

<li><p>Reduce 没有 setNumReduceTasks 是因为，该设置是根据该表当前 region 数量自动配置的。在建表时应当做好 region 的预切分， <code>HFileOutputFormat.configureIncrementalLoad()</code> 方法会根据 region 的数量来决定 reduce 的数量以及每个 reduce 覆盖的 rowkey 范围。否则当单个 reduce 过大时，任务处理不均衡。</p></li>

<li><p><code>completebulkload</code> 工具使用方法： <code>hadoop jar hbase-server-VERSION.jar completebulkload [-c /path/to/hbase/config/hbase-site.xml] /path/to/output table</code></p></li>
</ol>

<p>-EOF-</p>

<p>参考文章
<a href="http://blog.cloudera.com/blog/2013/09/how-to-use-hbase-bulk-loading-and-why/">How-to: Use HBase Bulk Loading, and Why</a>
<a href="http://hbase.apache.org/book.html#arch.bulk.load">Apache HBase ™ Reference Guide</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"><a rel="license noopener" href="https://blog.jrwang.me" target="_blank">jrthe42</a></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">原始链接</span>
    <span class="item-content"><a href="https://blog.jrwang.me/2015/import-data-to-hbase-using-bulk-loding/">https://blog.jrwang.me/2015/import-data-to-hbase-using-bulk-loding/</a></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2015-12-06
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/hbase/">HBase</a>
          <a href="/tags/mapreduce/">MapReduce</a>
          <a href="/tags/original/">Original</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2016/java-inner-class/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">关于 Java 内部类的小抄</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/2015/java-annotation/">
            <span class="next-text nav-default">Java 基础之注解</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="jrthe42/blog-comment"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:jrthe42@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/jrthe42" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/jrthe42" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://blog.jrwang.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2015 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author"><a rel="license noopener" href="https://blog.jrwang.me" target="_blank">jrthe42</a></span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.f79f403f.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-66913886-2', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
